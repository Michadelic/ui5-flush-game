/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/thirdparty/jquery"],function(e,t,n,i,r,s){"use strict";var a=/\(\$uid=[-\w]+\)$/,o="@com.sap.vocabularies.Common.v1.Messages",u=/^-?\d+$/,h=/^([^(]*)(\(.*\))$/;function l(e,t,n,i){if(n.$count!==undefined){d(e,t,n,n.$count+i)}}function c(e){return e.$count!==undefined?e.$count:Infinity}function f(e,t){return t===""||e===t||e.indexOf(t+"/")===0}function d(e,n,i,r){if(typeof r==="string"){r=parseInt(r)}t.updateExisting(e,n,i,{$count:r})}function p(e,n,i,r,s){this.bActive=true;this.mChangeListeners={};this.fnGetOriginalResourcePath=s;this.sMetaPath=t.getMetaPath("/"+n);this.mPatchRequests={};this.mPostRequests={};this.oRequestor=e;this.sResourcePath=n;this.bSortExpandSelect=r;this.bSentReadRequest=false;this.oTypePromise=undefined;this.setQueryOptions(i)}p.prototype._delete=function(n,i,r,s){var a=r.split("/"),o=a.pop(),u=a.join("/"),h=this;return this.fetchValue(e.$cached,u).then(function(e){var r=o?e[p.from$skip(o,e)]:e,a,l=t.getPrivateAnnotation(r,"predicate"),c=t.buildPath(u,Array.isArray(e)?l:o),f=t.getPrivateAnnotation(r,"transient");if(f===true){throw new Error("No 'delete' allowed while waiting for server response")}if(f){n.unlock();h.oRequestor.removePost(f,r);return Promise.resolve()}if(r["$ui5.deleting"]){throw new Error("Must not delete twice: "+i)}r["$ui5.deleting"]=true;a={"If-Match":r};i+=h.oRequestor.buildQueryString(h.sMetaPath,h.mQueryOptions,true);return h.oRequestor.request("DELETE",i,n,a,undefined,undefined,undefined,undefined,t.buildPath(h.sResourcePath,c)).catch(function(e){if(e.status!==404){delete r["$ui5.deleting"];throw e}}).then(function(){var n;if(Array.isArray(e)){n=e.indexOf(r);h.removeElement(e,n,l,u);s(n,e)}else{if(o){t.updateExisting(h.mChangeListeners,u,e,p.makeUpdateData([o],null))}else{r["$ui5.deleted"]=true}s()}h.oRequestor.getModelInterface().reportBoundMessages(h.sResourcePath,[],[c])})})};p.prototype.calculateKeyPredicate=function(e,n,i){var r,s=n[i];if(s&&s.$Key){r=t.getKeyPredicate(e,i,n);if(r){t.setPrivateAnnotation(e,"predicate",r)}}return r};p.prototype.checkActive=function(){var e;if(!this.bActive){e=new Error("Response discarded: cache is inactive");e.canceled=true;throw e}};p.prototype.create=function(i,a,o,u,h,c,f){var d,p=h&&h["@$ui5.keepTransientPath"],m=this;function P(){t.removeByPath(m.mPostRequests,o,h);d.shift();d.$created-=1;delete d.$byPredicate[u];c()}function y(){t.setPrivateAnnotation(h,"transient",true)}function g(n,i){var s=i.getGroupId();t.setPrivateAnnotation(h,"transient",s);t.addByPath(m.mPostRequests,o,h);return r.all([m.oRequestor.request("POST",n,i,null,h,y,P,undefined,t.buildPath(m.sResourcePath,o,u)),m.fetchTypes()]).then(function(e){var n=e[0],i;t.deletePrivateAnnotation(h,"transient");l(m.mChangeListeners,o,d,1);t.removeByPath(m.mPostRequests,o,h);m.visitResponse(n,e[1],t.getMetaPath(t.buildPath(m.sMetaPath,o)),o+u,p);if(!p){i=t.getPrivateAnnotation(n,"predicate");if(i){d.$byPredicate[i]=h;t.updateTransientPaths(m.mChangeListeners,u,i)}}t.updateSelected(m.mChangeListeners,t.buildPath(o,i||u),h,n,t.getSelectForPath(m.mQueryOptions,o));return h},function(t){if(t.canceled){throw t}f(t);return g(n,new e(m.oRequestor.getGroupSubmitMode(s)==="API"?s:"$parked."+s))})}h=s.extend(true,{},h);h=n.cleanPayload(h);t.setPrivateAnnotation(h,"transientPredicate",u);d=this.fetchValue(e.$cached,o).getResult();if(!Array.isArray(d)){throw new Error("Create is only supported for collections; '"+o+"' does not reference a collection")}d.unshift(h);d.$created+=1;d.$byPredicate=d.$byPredicate||{};d.$byPredicate[u]=h;return a.then(function(e){e+=m.oRequestor.buildQueryString(m.sMetaPath,m.mQueryOptions,true);return g(e,i)})};p.prototype.deregisterChange=function(e,n){t.removeByPath(this.mChangeListeners,e,n)};p.prototype.drillDown=function(e,n){var s=r.resolve(e),a=false,o=this;function u(e){i.error("Failed to drill-down into "+n+", invalid segment: "+e,o.toString(),"sap.ui.model.odata.v4.lib._Cache");return undefined}function l(e,i,r){var s="",h,l;if(n[0]!=="("){s+="/"}s+=n.split("/").slice(0,r).join("/");return o.oRequestor.getModelInterface().fetchMetadata(o.sMetaPath+t.getMetaPath(s)).then(function(n){if(!n){return u(i)}if(n.$Type==="Edm.Stream"){h=e[i+"@odata.mediaReadLink"];l=o.oRequestor.getServiceUrl();return h||l+o.sResourcePath+s}if(!a){return u(i)}if(n.$kind==="NavigationProperty"){return null}if(!n.$Type.startsWith("Edm.")){return{}}if("$DefaultValue"in n){return n.$Type==="Edm.String"?n.$DefaultValue:t.parseLiteral(n.$DefaultValue,n.$Type,s)}return null})}if(!n){return s}return n.split("/").reduce(function(e,n,i){return e.then(function(e){var r,s;if(n==="$count"){return Array.isArray(e)?e.$count:u(n)}if(e===undefined||e===null){return undefined}if(typeof e!=="object"||n==="@$ui5._"){return u(n)}s=e;a=a||t.getPrivateAnnotation(e,"transient");r=h.exec(n);if(r){if(r[1]){e=e[r[1]]}if(e){e=e.$byPredicate[r[2]]}}else{e=e[p.from$skip(n,e)]}return e===undefined&&n[0]!=="#"?l(s,n,i+1):e})},s)};p.prototype.fetchTypes=function(){var e,t,n=this;function i(e,t){if(t&&t.$expand){Object.keys(t.$expand).forEach(function(n){var r=e;n.split("/").forEach(function(e){r+="/"+e;s(r)});i(r,t.$expand[n])})}}function s(i){e.push(n.oRequestor.fetchTypeForPath(i).then(function(e){var r=n.oRequestor.getModelInterface().fetchMetadata(i+"/"+o).getResult();if(r){e=Object.create(e);e[o]=r}t[i]=e;if(e&&e.$Key){e.$Key.forEach(function(e){var t,n;if(typeof e!=="string"){n=e[Object.keys(e)[0]];t=n.lastIndexOf("/");if(t>=0){s(i+"/"+n.slice(0,t))}}})}}))}if(!this.oTypePromise){e=[];t={};s(this.sMetaPath);if(this.bFetchOperationReturnType){s(this.sMetaPath+"/$Type")}i(this.sMetaPath,this.mQueryOptions);this.oTypePromise=r.all(e).then(function(){return t})}return this.oTypePromise};p.prototype.getMeasureRangePromise=function(){return undefined};p.prototype.hasPendingChangesForPath=function(e){return Object.keys(this.mPatchRequests).some(function(t){return f(t,e)})||Object.keys(this.mPostRequests).some(function(t){return f(t,e)})};p.prototype.patch=function(n,i){var r=this;return this.fetchValue(e.$cached,n).then(function(e){t.updateExisting(r.mChangeListeners,n,e,i);return e})};p.prototype.registerChange=function(e,n){t.addByPath(this.mChangeListeners,e,n)};p.prototype.removeElement=function(e,n,i,r){var s=e[n],a;e.splice(n,1);if(i){delete e.$byPredicate[i]}a=t.getPrivateAnnotation(s,"transientPredicate");if(a){e.$created-=1;delete e.$byPredicate[a]}l(this.mChangeListeners,r,e,-1);if(!r&&"iLimit"in this){this.iLimit-=1}};p.prototype.resetChangesForPath=function(e){var n=this;Object.keys(this.mPatchRequests).forEach(function(t){var i,r;if(f(t,e)){r=n.mPatchRequests[t];for(i=r.length-1;i>=0;i--){n.oRequestor.removePatch(r[i])}delete n.mPatchRequests[t]}});Object.keys(this.mPostRequests).forEach(function(i){var r,s,a;if(f(i,e)){r=n.mPostRequests[i];for(s=r.length-1;s>=0;s--){a=t.getPrivateAnnotation(r[s],"transient");n.oRequestor.removePost(a,r[s])}delete n.mPostRequests[i]}})};p.prototype.setActive=function(e){this.bActive=e;if(!e){this.mChangeListeners={}}};p.prototype.setQueryOptions=function(e){if(this.bSentReadRequest){throw new Error("Cannot set query options: Cache has already sent a read request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};p.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};p.prototype.update=function(n,a,o,u,h,l,c,f,d){var m=a.split("/"),P,y=this;return this.fetchValue(n.getUnlockedCopy(),l).then(function(g){var v=t.buildPath(l,a),R=n.getGroupId(),E,$,b,q,w,M=p.makeUpdateData(m,o);function S(){t.removeByPath(y.mPatchRequests,v,$);t.updateExisting(y.mChangeListeners,l,g,p.makeUpdateData(m,E))}function A(n,i){var s;function a(){s=y.oRequestor.getModelInterface().lockGroup(R,true,y);if(d){d()}}$=y.oRequestor.request("PATCH",h,n,{"If-Match":g},M,a,S,undefined,t.buildPath(y.sResourcePath,l),i);t.addByPath(y.mPatchRequests,v,$);return r.all([$,y.fetchTypes()]).then(function(e){var n=e[0];t.removeByPath(y.mPatchRequests,v,$);if(!f){y.visitResponse(n,e[1],t.getMetaPath(t.buildPath(y.sMetaPath,l)),l)}t.updateExisting(y.mChangeListeners,l,g,f?{"@odata.etag":n["@odata.etag"]}:n)},function(n){var i=R;t.removeByPath(y.mPatchRequests,v,$);if(n.canceled){throw n}u(n);switch(y.oRequestor.getGroupSubmitMode(R)){case"API":break;case"Auto":if(!y.oRequestor.hasChanges(R,g)){i="$parked."+R}break;default:throw n}s.unlock();s=undefined;return A(new e(i),true)}).finally(function(){if(s){s.unlock()}})}if(!g){throw new Error("Cannot update '"+a+"': '"+l+"' does not exist")}q=t.getPrivateAnnotation(g,"transient");if(q){if(q===true){throw new Error("No 'update' allowed while waiting for server response")}if(q.indexOf("$parked.")===0){b=q;q=q.slice(8)}if(q!==R){throw new Error("The entity will be created via group '"+q+"'. Cannot patch via group '"+R+"'")}}E=t.drillDown(g,m);t.updateSelected(y.mChangeListeners,l,g,M);if(c){P=c.split("/");c=t.buildPath(l,c);w=y.fetchValue(e.$cached,c).getResult();if(w===undefined){i.debug("Missing value for unit of measure "+c+" when updating "+v,y.toString(),"sap.ui.model.odata.v4.lib._Cache")}else{s.extend(true,q?g:M,p.makeUpdateData(P,w))}}if(q){if(b){t.setPrivateAnnotation(g,"transient",q);y.oRequestor.relocate(b,g,q)}n.unlock();return Promise.resolve()}y.oRequestor.relocateAll("$parked."+R,g,R);h+=y.oRequestor.buildQueryString(y.sMetaPath,y.mQueryOptions,true);return A(n)})};p.prototype.visitResponse=function(e,n,i,r,s,u){var h,l=false,c={},f=this.oRequestor.getServiceUrl()+this.sResourcePath,p=this;function m(e,n,i){l=true;if(e&&e.length){c[n]=e;e.forEach(function(e){if(e.longtextUrl){e.longtextUrl=t.makeAbsolute(e.longtextUrl,i)}})}}function P(e,n){return n?t.makeAbsolute(n,e):e}function y(e,n,i,r){var s={},a,o,l,c;for(a=0;a<e.length;a++){l=e[a];o=i===""?u+a:a;if(l&&typeof l==="object"){g(l,n,i,r,o);c=t.getPrivateAnnotation(l,"predicate");if(!i){h.push(c||o.toString())}if(c){s[c]=l;e.$byPredicate=s}}}}function g(e,i,u,l,c){var f,v,R=n[i],E=R&&R[o]&&R[o].$Path,$;l=P(l,e["@odata.context"]);v=p.calculateKeyPredicate(e,n,i);if(c!==undefined){u=t.buildPath(u,v||c)}else if(!s&&v){f=a.exec(u);if(f){u=u.slice(0,-f[0].length)+v}}if(r&&!h){h=[u]}if(E){$=t.drillDown(e,E.split("/"));if($!==undefined){m($,u,l)}}Object.keys(e).forEach(function(n){var r,s=i+"/"+n,a=e[n],o=t.buildPath(u,n);if(n.endsWith("@odata.mediaReadLink")){e[n]=t.makeAbsolute(a,l)}if(n.includes("@")){return}if(Array.isArray(a)){a.$created=0;a.$count=undefined;r=e[n+"@odata.count"];if(r){d({},"",a,r)}else if(!e[n+"@odata.nextLink"]){d({},"",a,a.length)}y(a,s,o,P(l,e[n+"@odata.context"]))}else if(a&&typeof a==="object"){g(a,s,o,l)}})}if(u!==undefined){h=[];y(e.value,i||this.sMetaPath,"",P(f,e["@odata.context"]))}else if(e&&typeof e==="object"){g(e,i||this.sMetaPath,r||"",f)}if(l){this.oRequestor.getModelInterface().reportBoundMessages(this.fnGetOriginalResourcePath?this.fnGetOriginalResourcePath(e):this.sResourcePath,c,h)}};function m(e,t,n,i){p.apply(this,arguments);this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.aElements.$tail=undefined;this.iLimit=Infinity;this.oSyncPromiseAll=undefined}m.prototype=Object.create(p.prototype);m.prototype.fetchValue=function(e,t,n,i){var s,a=this;e.unlock();if(!this.oSyncPromiseAll){s=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=r.all(s)}return this.oSyncPromiseAll.then(function(){a.checkActive();a.registerChange(t,i);return a.drillDown(a.aElements,t)})};m.prototype.fill=function(e,t,n){var i,r=Math.max(this.aElements.length,1024);if(n>r){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+n+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;n=this.aElements.length}for(i=t;i<n;i++){this.aElements[i]=e}this.oSyncPromiseAll=undefined};m.prototype.getReadRange=function(e,t,n){var i=this.aElements;function r(e,t){var n;for(n=e;n<t;n+=1){if(i[n]===undefined){return true}}return false}if(r(e+t,e+t+n/2)){t+=n}if(r(Math.max(e-n/2,0),e)){t+=n;e-=n;if(e<0){t+=e;if(isNaN(t)){t=Infinity}e=0}}return{length:t,start:e}};m.prototype.getResourcePath=function(e,t){var n=this.sQueryString?"&":"?",i=t-e,r=this.sResourcePath+this.sQueryString;if(this.aElements.$created){if(e){e-=1}else{throw new Error("Must not request created element")}}if(e>0||i<Infinity){r+=n+"$skip="+e}if(i<Infinity){r+="&$top="+i}return r};m.prototype.handleResponse=function(e,n,i,r){var s,a,o,u,h,l=i.value.length;this.sContext=i["@odata.context"];a=i["@odata.count"];if(a){this.iLimit=parseInt(a);d(this.mChangeListeners,"",this.aElements,this.iLimit)}this.visitResponse(i,r,undefined,undefined,undefined,e);for(u=0;u<l;u++){o=i.value[u];this.aElements[e+u]=o;h=t.getPrivateAnnotation(o,"predicate");if(h){this.aElements.$byPredicate[h]=o}}if(l<n-e){s=Math.min(c(this.aElements),e+l-this.aElements.$created);this.aElements.length=this.aElements.$created+s;if(!a&&s>0&&!this.aElements[s-1]){s=undefined}d(this.mChangeListeners,"",this.aElements,s);this.iLimit=s}};m.prototype.read=function(e,t,n,i,s){var a,o,u,h,l=-1,c,f=this;if(e<0){throw new Error("Illegal index "+e+", must be >= 0")}if(t<0){throw new Error("Illegal length "+t+", must be >= 0")}if(this.aElements.$tail){return this.aElements.$tail.then(function(){return f.read(e,t,n,i,s)})}c=this.getReadRange(e,t,n);h=Math.min(c.start+c.length,this.aElements.$created+this.iLimit);o=Math.min(h,Math.max(c.start,this.aElements.length)+1);for(a=c.start;a<o;a++){if(this.aElements[a]!==undefined){if(l>=0){this.requestElements(l,a,i.getUnlockedCopy(),s);s=undefined;l=-1}}else if(l<0){l=a}}if(l>=0){this.requestElements(l,h,i.getUnlockedCopy(),s)}i.unlock();u=this.aElements.slice(e,h);if(this.aElements.$tail){u.push(this.aElements.$tail)}return r.all(u).then(function(){var t;f.checkActive();t={"@odata.context":f.sContext,value:f.aElements.slice(e,h)};t.value.$count=f.aElements.$count;return t})};m.prototype.requestElements=function(e,t,n,i){var s,a=this;s=r.all([this.oRequestor.request("GET",this.getResourcePath(e,t),n,undefined,undefined,i),this.fetchTypes()]).then(function(n){if(a.aElements.$tail===s){a.aElements.$tail=undefined}a.handleResponse(e,t,n[0],n[1])}).catch(function(n){a.fill(undefined,e,t);throw n});this.bSentReadRequest=true;this.fill(s,e,t)};m.prototype.refreshSingle=function(e,n,i){var a=t.getPrivateAnnotation(this.aElements[n],"predicate"),o,u=this.sResourcePath+a,h=s.extend({},this.mQueryOptions),l=this;delete h["$count"];delete h["$filter"];delete h["$orderby"];u+=this.oRequestor.buildQueryString(this.sMetaPath,h,false,this.bSortExpandSelect);o=r.all([this.oRequestor.request("GET",u,e,undefined,undefined,i),this.fetchTypes()]).then(function(e){var t=e[0];l.replaceElement(n,a,t,e[1]);return t});this.bSentReadRequest=true;return o};m.prototype.refreshSingleWithRemove=function(e,n,i,r){var a=this;return this.fetchTypes().then(function(o){var u=a.aElements[n],h=t.getPrivateAnnotation(u,"predicate"),l=s.extend({},a.mQueryOptions),c=l["$filter"],f=a.sResourcePath;l["$filter"]=(c?"("+c+") and ":"")+t.getKeyFilter(u,a.sMetaPath,o);f+=a.oRequestor.buildQueryString(a.sMetaPath,l,false,a.bSortExpandSelect);a.bSentReadRequest=true;return a.oRequestor.request("GET",f,e,undefined,undefined,i).then(function(e){if(a.aElements[n]!==u){n=a.aElements.indexOf(u)}if(e.value.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(e.value.length===0){a.removeElement(a.aElements,n,h,"");r(n)}else{a.replaceElement(n,h,e.value[0],o)}})})};m.prototype.replaceElement=function(e,n,i,r){var s=this.aElements[e],a,o=this;this.aElements[e]=this.aElements.$byPredicate[n]=i;a=t.getPrivateAnnotation(s,"transientPredicate");if(a){o.aElements.$byPredicate[a]=i;t.setPrivateAnnotation(i,"transientPredicate",a)}this.visitResponse(i,r,undefined,n)};m.prototype.requestSideEffects=function(e,n,i,s,a){var o,u,h=[],l=t.intersectQueryOptions(this.mQueryOptions,n,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,i),c,f=this.fetchTypes().getResult(),d=this,p;if(!l){return r.resolve()}for(p=0;p<this.aElements.length;p+=1){o=this.aElements[p];if(!o||t.hasPrivateAnnotation(o,"transient")){continue}if((p<s||p>=s+a)&&!t.hasPrivateAnnotation(o,"transientPredicate")){delete this.aElements.$byPredicate[t.getPrivateAnnotation(o,"predicate")];delete this.aElements[p];continue}u=t.getKeyFilter(o,this.sMetaPath,f);if(!u){return null}h.push(u)}this.aElements.length=a?Math.min(s+a,this.aElements.length):this.aElements.$created;if(!h.length){return r.resolve()}l.$filter=h.join(" or ");t.selectKeyProperties(l,f[this.sMetaPath]);delete l.$count;delete l.$orderby;delete l.$search;c=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,l,false,true);return this.oRequestor.request("GET",c,e).then(function(e){var n,i,r,s;if(e.value.length!==h.length){throw new Error("Expected "+h.length+" row(s), but instead saw "+e.value.length)}d.visitResponse(e,f,undefined,"",false,NaN);for(r=0,s=e.value.length;r<s;r+=1){n=e.value[r];i=t.getPrivateAnnotation(n,"predicate");t.updateExisting(d.mChangeListeners,i,d.aElements.$byPredicate[i],n)}})};function P(e,t,n){p.call(this,e,t,n);this.oPromise=null}P.prototype=Object.create(p.prototype);P.prototype._delete=function(){throw new Error("Unsupported")};P.prototype.create=function(){throw new Error("Unsupported")};P.prototype.fetchValue=function(e,t,n,i){var s=this;s.registerChange("",i);if(this.oPromise){e.unlock()}else{this.oPromise=r.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,n,undefined,this.sMetaPath));this.bSentReadRequest=true}return this.oPromise.then(function(e){s.checkActive();return e.value})};P.prototype.update=function(){throw new Error("Unsupported")};function y(e,t,n,i,r,s,a,o){p.apply(this,arguments);this.bFetchOperationReturnType=o;this.sMetaPath=a||this.sMetaPath;this.bPost=s;this.bPosting=false;this.oPromise=null}y.prototype=Object.create(p.prototype);y.prototype.fetchValue=function(e,t,n,i){var s=this.sResourcePath+this.sQueryString,a=this;this.registerChange(t,i);if(this.oPromise){e.unlock()}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=r.all([this.oRequestor.request("GET",s,e,undefined,undefined,n,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){a.visitResponse(e[0],e[1],a.bFetchOperationReturnType?a.sMetaPath+"/$Type":undefined);return e[0]});this.bSentReadRequest=true}return this.oPromise.then(function(e){a.checkActive();if(e["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}return a.drillDown(e,t)})};y.prototype.post=function(e,t,n){var i=e.getGroupId(),s="POST",a=this;if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}this.oRequestor.relocateAll("$parked."+i,n,i);if(t){s=t["X-HTTP-Method"]||s;delete t["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(t).length){t=undefined}}this.oPromise=r.all([this.oRequestor.request(s,this.sResourcePath+this.sQueryString,e,{"If-Match":n},t),this.fetchTypes()]).then(function(e){a.bPosting=false;a.visitResponse(e[0],e[1],a.bFetchOperationReturnType?a.sMetaPath+"/$Type":undefined);return e[0]},function(e){a.bPosting=false;throw e});this.bPosting=true;return this.oPromise};y.prototype.requestSideEffects=function(n,i,s,a){var o=this.fetchValue(e.$cached,""),u=t.intersectQueryOptions(this.mQueryOptions,i,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath+"/$Type",s),h,l=this;if(!u){return o}a=(a||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,u,false,true);h=r.all([this.oRequestor.request("GET",a,n),this.fetchTypes(),o]).then(function(e){var n=e[0],i=e[2];l.visitResponse(n,e[1]);t.updateExisting(l.mChangeListeners,"",i,n);return i});this.oPromise=h.catch(function(){return o});return h};p.create=function(e,t,n,i){return new m(e,t,n,i)};p.createProperty=function(e,t,n){return new P(e,t,n)};p.createSingle=function(e,t,n,i,r,s,a,o){return new y(e,t,n,i,r,s,a,o)};p.from$skip=function(e,t){return u.test(e)?t.$created+Number(e):e};p.makeUpdateData=function(e,t){return e.reduceRight(function(e,t){var n={};n[t]=e;return n},t)};return p},false);