/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/base/EventProvider","sap/ui/core/InvisibleText","sap/ui/core/ListItem","sap/ui/core/ResizeHandler","sap/m/library","sap/m/Bar","sap/m/Button","sap/m/ColumnListItem","sap/m/GroupHeaderListItem","sap/ui/core/SeparatorItem","sap/m/Dialog","sap/m/DisplayListItem","sap/m/List","sap/m/Popover","sap/m/StandardListItem","sap/m/Table","sap/base/security/encodeXML","sap/ui/events/KeyCodes"],function(e,t,i,s,o,n,r,a,u,p,l,h,g,_,d,f,c,I,m){"use strict";var b=n.ListMode;var S=n.PlacementType;var T=n.ListType;var v=t.extend("sap.m.SuggestionsPopover",{constructor:function(i){t.apply(this,arguments);this._oInput=i;this._bUseDialog=e.system.phone;this._iPopupListSelectedIndex=-1;this._sPopoverContentWidth=null;this._bEnableHighlighting=true;this._bIsInputIncrementalType=false;this._bAutocompleteEnabled=false;this._sTypedInValue="";this._oInput.addEventDelegate({onsapup:function(e){this._onsaparrowkey(e,"up",1)},onsapdown:function(e){this._onsaparrowkey(e,"down",1)},onsappageup:function(e){this._onsaparrowkey(e,"up",5)},onsappagedown:function(e){this._onsaparrowkey(e,"down",5)},onsaphome:function(e){if(this._oList){this._onsaparrowkey(e,"up",this._oList.getItems().length)}},onsapend:function(e){if(this._oList){this._onsaparrowkey(e,"down",this._oList.getItems().length)}},onsapright:this._onsapright},this)},destroy:function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this._oList){this._oList.destroy();this._oList=null}if(this._oSuggestionTable){this._oSuggestionTable.destroy();this._oSuggestionTable=null}this._oProposedItem=null;this._oInputDelegate=null}});v.M_EVENTS={SELECTION_CHANGE:"selectionChange"};v._wordStartsWithValue=function(e,t){var i;while(e){if(typeof t==="string"&&t!==""&&e.toLowerCase().startsWith(t.toLowerCase())){return true}i=e.indexOf(" ");if(i==-1){break}e=e.substring(i+1)}return false};v._DEFAULTFILTER=function(e,t){if(t instanceof s&&v._wordStartsWithValue(t.getAdditionalText(),e)){return true}return v._wordStartsWithValue(t.getText(),e)};v._DEFAULTFILTER_TABULAR=function(e,t){var i=t.getCells(),s=0;for(;s<i.length;s++){if(i[s].getText){if(v._wordStartsWithValue(i[s].getText(),e)){return true}}}return false};v._DEFAULTRESULT_TABULAR=function(e){var t=e.getCells(),i=0;for(;i<t.length;i++){if(t[i].getText){return t[i].getText()}}return""};v.prototype._createSuggestionPopup=function(){var e=this._oInput,t=e._oRb;this._oPopover=!this._bUseDialog?new d(e.getId()+"-popup",{showArrow:false,showHeader:false,placement:S.Vertical,initialFocus:e,horizontalScrolling:true}):new h(e.getId()+"-popup",{beginButton:new a(e.getId()+"-popup-closeButton",{text:t.getText("MSGBOX_CLOSE")}),stretch:true,customHeader:new r(e.getId()+"-popup-header",{contentMiddle:this._oPopupInput}),horizontalScrolling:false,initialFocus:this._oPopupInput});this._registerAutocomplete();this._oPopover.addStyleClass("sapMInputSuggestionPopup");this._oPopover.addAriaLabelledBy(i.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(!this._bUseDialog){this._overwritePopover()}if(this._oList){this._oPopover.addContent(this._oList)}};v.prototype._createSuggestionPopupContent=function(e,t){var i=this._oInput;if(!t&&!e){this._oList=new _(i.getId()+"-popup-list",{showNoData:false,mode:b.SingleSelectMaster,rememberSelections:false});this._oList.addEventDelegate({onAfterRendering:function(){if(!this._bEnableHighlighting){return}this._highlightListText(i.getValue())}.bind(this)})}else{this._oList=this._getSuggestionsTable()}if(this._oPopover){if(this._bUseDialog){this._oPopover.addAggregation("content",this._oList,true);var s=this._oPopover.$("scrollCont")[0];if(s){var o=sap.ui.getCore().createRenderManager();o.renderControl(this._oList);o.flush(s);o.destroy()}}else{this._oPopover.addContent(this._oList)}}};v.prototype._destroySuggestionPopup=function(){if(this._oPopover){if(this._oList instanceof c){this._oPopover.removeAllContent()}this._oPopover.destroy();this._oPopover=null}if(this._oList instanceof _){this._oList.destroy();this._oList=null}this._getInput().removeEventDelegate(this._oInputDelegate,this)};v.prototype._overwritePopover=function(){var e=this._oInput;this._oPopover.open=function(){this.openBy(e,false,true)};this._oPopover.oPopup.setAnimations(function(e,t,i){i()},function(e,t,i){i()})};v.prototype._resizePopup=function(){var e=this._oInput;if(this._oList&&this._oPopover){if(this._sPopoverContentWidth){this._oPopover.setContentWidth(this._sPopoverContentWidth)}else{this._oPopover.setContentWidth(e.$().outerWidth()+"px")}setTimeout(function(){if(this._oPopover&&this._oPopover.isOpen()&&this._oPopover.$().outerWidth()<e.$().outerWidth()){this._oPopover.setContentWidth(e.$().outerWidth()+"px")}}.bind(this),0)}};v.prototype._registerResize=function(){if(!this._bUseDialog){this._sPopupResizeHandler=o.register(this._oInput,this._resizePopup.bind(this))}};v.prototype._deregisterResize=function(){if(this._sPopupResizeHandler){this._sPopupResizeHandler=o.deregister(this._sPopupResizeHandler)}};v.prototype._onsaparrowkey=function(t,i,s){var o=this._oInput,n,r=o.$("inner");if(t.isMarked()){return}if(t.isMarked()){return}if(!o.getEnabled()||!o.getEditable()){return}if(i!=="up"&&i!=="down"){return}if(this._bIsInputIncrementalType){t.setMarked()}if(!this._oPopover||!this._oPopover.isOpen()){return}t.preventDefault();t.stopPropagation();var a=false,p=this._oList,l=p.getItems(),h=this._iPopupListSelectedIndex,_,d=h;if(i==="up"&&h===0){return}if(i=="down"&&h===l.length-1){return}var f;if(s>1){if(i=="down"&&h+s>=l.length){i="up";s=1;l[h].setSelected(false);f=h;h=l.length-1;a=true}else if(i=="up"&&h-s<0){i="down";s=1;l[h].setSelected(false);f=h;h=0;a=true}}if(h===-1){h=0;if(this._isSuggestionItemSelectable(l[h])){d=h;a=true}else{i="down"}}if(i==="down"){while(h<l.length-1&&(!a||!this._isSuggestionItemSelectable(l[h]))){l[h].setSelected(false);h=h+s;a=true;s=1;if(f===h){break}}}else{while(h>0&&(!a||!l[h].getVisible()||!this._isSuggestionItemSelectable(l[h]))){l[h].setSelected(false);h=h-s;a=true;s=1;if(f===h){break}}}if(!this._isSuggestionItemSelectable(l[h])){if(d>=0){l[d].setSelected(true).updateAccessibilityState();r.attr("aria-activedescendant",l[d].getId())}return}else{n=l[h];n.setSelected(true).updateAccessibilityState();if(n.isA("sap.m.GroupHeaderListItem")){r.removeAttr("aria-activedescendant")}else{r.attr("aria-activedescendant",l[h].getId())}}if(e.system.desktop){this._scrollToItem(h)}this._oLastSelectedHeader&&this._oLastSelectedHeader.removeStyleClass("sapMInputFocusedHeaderGroup");if(u&&l[h]instanceof u){_=o._getInputValue(o._fnRowResultFilter(l[h]))}else{if(l[h].isA("sap.m.GroupHeaderListItem")){_="";l[h].addStyleClass("sapMInputFocusedHeaderGroup");this._oLastSelectedHeader=l[h]}else if(l[h]instanceof g){_=o._getInputValue(l[h].getLabel())}else{_=o._getInputValue(l[h].getTitle())}}this._iPopupListSelectedIndex=h;this._bSuggestionItemChanged=true;this.fireEvent(v.M_EVENTS.SELECTION_CHANGE,{newValue:_})};v.prototype._isSuggestionItemSelectable=function(e){var t=this._hasTabularSuggestions()||e.getType()!==T.Inactive||e.isA("sap.m.GroupHeaderListItem");return e.getVisible()&&t};v.prototype._hasTabularSuggestions=function(){if(!this._oSuggestionTable){return}return!!(this._oSuggestionTable.getColumns()&&this._oSuggestionTable.getColumns().length)};v.prototype._scrollToItem=function(e){var t=this._oPopover,i=this._oList,s,o,n,r,a;if(!(t instanceof d)||!i){return}s=t.getScrollDelegate();if(!s){return}var u=i.getItems()[e],p=u&&u.getDomRef();if(!p){return}o=t.getDomRef("cont").getBoundingClientRect();n=p.getBoundingClientRect();r=o.top-n.top;a=n.bottom-o.bottom;if(r>0){s.scrollTo(s._scrollX,Math.max(s._scrollY-r,0))}else if(a>0){s.scrollTo(s._scrollX,s._scrollY+a)}};v.prototype._getSuggestionsTable=function(){var t=this._oInput;if(t._bIsBeingDestroyed){return this._oSuggestionTable}if(!this._oSuggestionTable){this._oSuggestionTable=new c(t.getId()+"-popup-table",{mode:b.SingleSelectMaster,showNoData:false,showSeparators:"All",width:"100%",enableBusyIndicator:false,rememberSelections:false,selectionChange:function(i){if(e.system.desktop){t.focus()}this._bSuggestionItemTapped=true;var s=i.getParameter("listItem");t.setSelectionRow(s,true)}.bind(this)});this._oSuggestionTable.addEventDelegate({onAfterRendering:function(){if(!t.getEnableSuggestionsHighlighting()){return}this._highlightTableText(t.getValue())}.bind(this)});if(this._bUseDialog){this._oSuggestionTable.addStyleClass("sapMInputSuggestionTableHidden")}this._oSuggestionTable.updateItems=function(){c.prototype.updateItems.apply(t,arguments);t._refreshItemsDelayed();return t}}t._oSuggestionTable=this._oSuggestionTable;return this._oSuggestionTable};v.prototype._createHighlightedText=function(e){var t=e.innerText,i=(this._sTypedInValue||this._oInput.getValue()).toLowerCase(),s=i.length,o=t.toLowerCase(),n,r="";if(!v._wordStartsWithValue(t,i)){return I(t)}var a=o.indexOf(i);if(a>0){a=o.indexOf(" "+i)+1}if(a>-1){r+=I(t.substring(0,a));n=t.substring(a,a+s);r+='<span class="sapMInputHighlight">'+I(n)+"</span>";r+=I(t.substring(a+s))}else{r=I(t)}return r};v.prototype._highlightListText=function(){if(!this._bEnableHighlighting){return}var e,t,i=this._oList.$().find(".sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue");for(e=0;e<i.length;e++){t=i[e];t.innerHTML=this._createHighlightedText(t)}};v.prototype._highlightTableText=function(){if(!this._bEnableHighlighting){return}var e,t,i=this._oSuggestionTable.$().find("tbody .sapMLabel");for(e=0;e<i.length;e++){t=i[e];t.innerHTML=this._createHighlightedText(t)}};v.prototype._registerAutocomplete=function(){var e=this._oPopover,t=this._getInput(),i=this._bUseDialog;if(i){e.addEventDelegate({ontap:function(){if(!this._bSuggestionItemTapped&&this._sProposedItemText){t.setValue(this._sProposedItemText);this._sProposedItemText=null}}},this)}else{e.attachAfterOpen(this._handleTypeAhead,this)}e.attachAfterClose(this._finalizeAutocomplete,this);this._oInputDelegate={onkeydown:function(e){this._bDoTypeAhead=this._bAutocompleteEnabled&&e.which!==m.BACKSPACE&&e.which!==m.DELETE},oninput:this._handleTypeAhead};t.addEventDelegate(this._oInputDelegate,this)};v.prototype._handleTypeAhead=function(){var t=this._getInput(),i=t.getValue();this._oProposedItem=null;this._sTypedInValue=i;if(!this._bDoTypeAhead||i===""){return}if(!this._oPopover.isOpen()||i.length<this._oInput.getStartSuggestion()){return}if(document.activeElement!==t.getFocusDomRef()){return}var s=i.toLowerCase(),o=this._hasTabularSuggestions(),n=o?this._oInput.getSuggestionRows():this._oInput.getSuggestionItems(),r,a,u,p;n=n.filter(function(e){return!(e.isA("sap.ui.core.SeparatorItem")||e.isA("sap.m.GroupHeaderListItem"))});r=n.length;for(p=0;p<r;p++){u=o?this._oInput._fnRowResultFilter(n[p]):n[p].getText();if(u.toLowerCase().startsWith(s)){this._oProposedItem=n[p];a=u;break}}this._sProposedItemText=a;if(a){a=this._formatTypedAheadValue(a);t.updateDomValue(a);if(e.system.desktop){t.selectText(i.length,a.length)}else{setTimeout(function(){t.selectText(i.length,a.length)},0)}}};v.prototype._getInput=function(){return this._bUseDialog?this._oPopupInput:this._oInput};v.prototype._finalizeAutocomplete=function(){if(!this._bAutocompleteEnabled){return}if(!this._bSuggestionItemTapped&&!this._bSuggestionItemChanged&&this._oProposedItem){if(this._hasTabularSuggestions()){this._oInput.setSelectionRow(this._oProposedItem,true)}else{this._oInput.setSelectionItem(this._oProposedItem,true)}}if(this._oProposedItem&&document.activeElement===this._oInput.getFocusDomRef()){var e=this._oInput.getValue().length;this._oInput.selectText(e,e)}this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue="";this._bSuggestionItemTapped=false;this._bSuggestionItemChanged=false};v.prototype._formatTypedAheadValue=function(e){return this._sTypedInValue.concat(e.substring(this._sTypedInValue.length,e.length))};v.prototype._onsapright=function(){var e=this._oInput,t=e.getValue();if(!this._bAutocompleteEnabled){return}if(this._sTypedInValue!==t){this._sTypedInValue=t;e.fireLiveChange({value:t,newValue:t})}};return v});