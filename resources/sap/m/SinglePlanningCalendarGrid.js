/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./SinglePlanningCalendarUtilities","sap/ui/core/Control","sap/ui/core/LocaleData","sap/ui/core/Locale","sap/ui/core/InvisibleText","sap/ui/core/format/DateFormat","sap/ui/core/date/UniversalDate","sap/ui/core/dnd/DragInfo","sap/ui/core/dnd/DropInfo","sap/ui/core/dnd/DragDropInfo","sap/ui/unified/library","sap/ui/unified/calendar/DatesRow","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/events/KeyCodes","./SinglePlanningCalendarGridRenderer"],function(t,e,i,r,n,a,o,s,l,p,g,u,d,c,h,m){"use strict";var f=69,D=48,_=34,y=25,A=36e5/2,v=60*1e3,C=864e5;var S=e.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}}}}});S.prototype.init=function(){var t=new Date,e=new u(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:t}).addStyleClass("sapMSinglePCColumnHeader"),i=(60-t.getSeconds())*1e3;this.setAggregation("_columnHeaders",e);this.setStartDate(t);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatAria=a.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' HH:mm:ss a"});setTimeout(this._updateRowHeaderAndNowMarker.bind(this),i)};S.prototype.onBeforeRendering=function(){var t=this._createAppointmentsMap(this.getAppointments()),e=this.getStartDate(),i=d.fromLocalJSDate(e),r=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(t.appointments,this.getStartDate(),r);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(t.blockers,i,r);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==r||this._oOldStartDate!==e){this._createBlockersDndPlaceholders(e,r);this._createAppointmentsDndPlaceholders(e,r)}};S.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new p({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsDragAndDrop()){t.preventDefault();return false}var e=function(){var t=jQuery(".sapMSinglePCOverlay");setTimeout(function(){t.addClass("sapMSinglePCOverlayDragging")});jQuery(document).one("dragend",function(){t.removeClass("sapMSinglePCOverlayDragging")})};e()}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),i=e.getDragControl(),r=e.getDropControl(),n=this.isAllDayAppointment(i.getStartDate(),i.getEndDate()),a=function(){var t=jQuery(e.getIndicator()),a=i.$().outerHeight(),o=i.$().outerWidth(),s=r.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),l=r.getDomRef().getBoundingClientRect(),p=l.left+o-(s.left+s.width);if(n){t.css("min-height",a);t.css("min-width",Math.min(o,o-p))}else{t.css("min-height",e.getDropControl().$().outerHeight());t.css("min-width",e.getDropControl().$().outerWidth())}};if(!e.getIndicator()){setTimeout(a,0)}else{a()}}.bind(this),drop:function(t){var e=t.getParameter("dragSession"),i=e.getDragControl(),r=e.getDropControl(),n=r.getDate().getJSDate(),a,o=t.getParameter("browserEvent"),s=o.metaKey||o.ctrlKey,l=this.isAllDayAppointment(i.getStartDate(),i.getEndDate());a=new Date(n);if(l){a.setMilliseconds(i.getEndDate().getTime()-i.getStartDate().getTime())}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(l&&i.getStartDate().getTime()===n.getTime()){return}this.fireAppointmentDrop({appointment:i,startDate:n,endDate:a,copy:s})}.bind(this)}))};S.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new p({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsDragAndDrop()){t.preventDefault();return false}var e=function(){var t=jQuery(".sapMSinglePCOverlay");setTimeout(function(){t.addClass("sapMSinglePCOverlayDragging")});jQuery(document).one("dragend",function(){t.removeClass("sapMSinglePCOverlayDragging")})};e()}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),i=e.getDragControl(),r=e.getDropControl(),n=this.isAllDayAppointment(i.getStartDate(),i.getEndDate()),a=function(){var t=jQuery(e.getIndicator()),a=i.$().outerHeight(),o=r.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),s=e.getDropControl().getDomRef().getBoundingClientRect(),l=s.top+a-(o.top+o.height);if(n){t.css("min-height",2*e.getDropControl().$().outerHeight())}else{t.css("min-height",Math.min(a,a-l))}};if(!e.getIndicator()){setTimeout(a,0)}else{a()}}.bind(this),drop:function(t){var e=t.getParameter("dragSession"),i=e.getDragControl(),r=e.getDropControl(),n=r.getDate().getJSDate(),a,o=t.getParameter("browserEvent"),s=o.metaKey||o.ctrlKey,l=this.isAllDayAppointment(i.getStartDate(),i.getEndDate());a=new Date(n);if(l){a.setHours(a.getHours()+1)}else{a.setMilliseconds(i.getEndDate().getTime()-i.getStartDate().getTime())}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!l&&i.getStartDate().getTime()===n.getTime()){return}this.fireAppointmentDrop({appointment:i,startDate:n,endDate:a,copy:s})}.bind(this)}))};S.prototype._adjustAppointmentsHeightforCompact=function(t,e,i){var r,n,a,o,s,l,p,g,u=this._getRowHeight(),d=this;if(this._oAppointmentsToRender[t]){this._oAppointmentsToRender[t].oAppointmentsList.getIterator().forEach(function(c){r=c.getData();n=jQuery("div[data-sap-day='"+t+"'].sapMSinglePCColumn #"+r.getId());a=r.getStartDate();o=r.getEndDate();p=e.getTime()>a.getTime();g=i.getTime()<o.getTime();s=p?0:d._calculateTopPosition(a);l=g?0:d._calculateBottomPosition(o);n.css("top",s);n.css("bottom",l);n.find(".sapUiCalendarApp").css("min-height",u/2-1)})}};S.prototype._adjustBlockersHeightforCompact=function(){var t=this._getBlockersToRender().iMaxlevel,e=(t+1)*this._getBlockerRowHeight(),i=this._getBlockerRowHeight();if(t>0){e=e+3}this.$().find(".sapMSinglePCBlockersColumns").css("height",e);this._oBlockersToRender.oBlockersList.getIterator().forEach(function(t){t.getData().$().css("top",i*t.level+1)})};S.prototype.onAfterRendering=function(){var t=this._getColumns(),e=this.getStartDate(),i=this._getRowHeight();if(i===D){for(var r=0;r<t;r++){var n=new d(e.getFullYear(),e.getMonth(),e.getDate()+r),a=this._formatDayAsString(n),s=new o(n.getYear(),n.getMonth(),n.getDate(),this._getVisibleStartHour()),l=new o(n.getYear(),n.getMonth(),n.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(a,s,l)}this._adjustBlockersHeightforCompact()}};S.prototype.onkeydown=function(t){var e;if(t.which===h.SPACE||t.which===h.ENTER){e=sap.ui.getCore().byId(t.target.id);if(e&&e.isA("sap.ui.unified.CalendarAppointment")){this._toggleAppointmentSelection(e,!(t.ctrlKey||t.metaKey));this.fireAppointmentSelect({appointment:e})}t.preventDefault()}};S.prototype.setStartDate=function(t){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(t);return this.setProperty("startDate",t)};S.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(t){return t.getSelected()})};S.prototype._toggleAppointmentSelection=function(t,e){var i,r,n;if(e){i=this.getAppointments();for(r=0,n=i.length;r<n;r++){if(i[r].getId()!==t.getId()&&i[r].getSelected()){i[r].setProperty("selected",false,true);jQuery("[data-sap-ui="+i[r].getId()+"]").find(".sapUiCalendarApp").removeClass("sapUiCalendarAppSel")}}}t.setProperty("selected",!t.getSelected(),true);jQuery("[data-sap-ui="+t.getId()+"]").find(".sapUiCalendarApp").toggleClass("sapUiCalendarAppSel",t.getSelected())};S.prototype.ontap=function(t){var e=sap.ui.getCore().byId(t.target.parentElement.id);if(e&&e.isA("sap.ui.unified.CalendarAppointment")){this._toggleAppointmentSelection(e,!(t.ctrlKey||t.metaKey));this.fireAppointmentSelect({appointment:e})}};S.prototype._getVisibleStartHour=function(){return 0};S.prototype._getVisibleEndHour=function(){return 23};S.prototype._isVisibleHour=function(){return true};S.prototype._isOutsideVisibleHours=function(){return false};S.prototype._shouldHideRowHeader=function(t){var e=(new Date).getHours(),i=c._areCurrentMinutesLessThan(15)&&e===t,r=c._areCurrentMinutesMoreThan(45)&&e===t-1;return i||r};S.prototype._formatDayAsString=function(t){var e=""+t.getYear(),i=t.getMonth(),r=t.getDate();if(i<10){e+="0"}e+=i;if(r<10){e+="0"}e+=r;return e};S.prototype._formatTimeAsString=function(t){var e=this._getHoursPattern()+":mm",i=a.getDateTimeInstance({pattern:e},new r(this._getCoreLocaleId()));return i.format(t)};S.prototype._addAMPM=function(t){var e=this._getAMPMFormat();return" "+e.format(t)};S.prototype._calculateTopPosition=function(t){var e=t.getHours()-this._getVisibleStartHour(),i=t.getMinutes(),r=this._getRowHeight();return r*e+r/60*i};S.prototype._calculateBottomPosition=function(t){var e=this._getVisibleEndHour()+1-t.getHours(),i=t.getMinutes(),r=this._getRowHeight();return r*e-r/60*i};S.prototype._updateRowHeaderAndNowMarker=function(){var t=new Date;this._updateNowMarker(t);this._updateRowHeaders(t);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),v)};S.prototype._updateNowMarker=function(t){var e=this.$("nowMarker"),i=this.$("nowMarkerText"),r=this.$("nowMarkerAMPM"),n=this._isOutsideVisibleHours(t.getHours());e.toggleClass("sapMSinglePCNowMarkerHidden",n);e.css("top",this._calculateTopPosition(t)+"px");i.text(this._formatTimeAsString(t));r.text(this._addAMPM(t));i.append(r)};S.prototype._updateRowHeaders=function(t){var e=this.$(),i=t.getHours(),r=i+1;e.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(i)){e.find(".sapMSinglePCRowHeader"+i).addClass("sapMSinglePCRowHeaderHidden")}else if(this._shouldHideRowHeader(r)){e.find(".sapMSinglePCRowHeader"+r).addClass("sapMSinglePCRowHeaderHidden")}};S.prototype._createAppointmentsMap=function(t){var e=this;return t.reduce(function(t,i){var r=i.getStartDate(),n=i.getEndDate(),a,o,s;if(!r||!n){return t}if(!e.isAllDayAppointment(r,n)){a=d.fromLocalJSDate(r);o=d.fromLocalJSDate(n);while(a.isSameOrBefore(o)){s=e._formatDayAsString(a);if(!t.appointments[s]){t.appointments[s]=[]}t.appointments[s].push(i);a.setDate(a.getDate()+1)}}else{t.blockers.push(i)}return t},{appointments:{},blockers:[]})};S.prototype._calculateVisibleAppointments=function(t,e,i){var r={},n,a,o;for(var s=0;s<i;s++){n=new d(e.getFullYear(),e.getMonth(),e.getDate()+s);a=this._formatDayAsString(n);o=this._isAppointmentFitInVisibleHours(n);if(t[a]){r[a]=t[a].filter(o,this).sort(this._sortAppointmentsByStartHourCallBack)}}return r};S.prototype._isAppointmentFitInVisibleHours=function(t){return function(e){var i=e.getStartDate().getTime(),r=e.getEndDate().getTime(),n=new o(t.getYear(),t.getMonth(),t.getDate(),this._getVisibleStartHour()).getTime(),a=new o(t.getYear(),t.getMonth(),t.getDate(),this._getVisibleEndHour(),59,59).getTime();var s=i<n&&r>a,l=i>=n&&i<a,p=r>n&&r<=a;return s||l||p}};S.prototype._calculateAppointmentsLevelsAndWidth=function(e){var i=this;return Object.keys(e).reduce(function(r,n){var a=0,o=new t.list,s=e[n];s.forEach(function(e){var i=new t.node(e),r=e.getStartDate().getTime();if(o.getSize()===0){o.add(i);return}o.getIterator().forEach(function(t){var e=true,n=t.getData(),o=n.getStartDate().getTime(),s=n.getEndDate().getTime(),l=s-o;if(l<A){s=s+(A-l)}if(r>=o&&r<s){i.level++;a=Math.max(a,i.level)}if(t.next&&t.next.level===i.level){e=false}if(r>=s&&e){this.interrupt()}});o.insertAfterLevel(i.level,i)});r[n]={oAppointmentsList:i._calculateAppointmentsWidth(o),iMaxLevel:a};return r},{})};S.prototype._calculateAppointmentsWidth=function(e){e.getIterator().forEach(function(i){var r=i.getData(),n=i.level,a=i.level,o=r.getStartDate().getTime(),s=r.getEndDate().getTime(),l=s-o;if(l<A){s=s+(A-l)}new t.iterator(e).forEach(function(t){var e=t.getData(),r=t.level,l=e.getStartDate().getTime(),p=e.getEndDate().getTime(),g=p-l;if(g<A){p=p+(A-g)}if(a>=r){return}if(o>=l&&o<p||s>l&&s<p||o<=l&&s>=p){i.width=r-a;this.interrupt();return}if(n<r){n=r;i.width++}})});return e};S.prototype._calculateVisibleBlockers=function(t,e,i){var r=new d(e.getYear(),e.getMonth(),e.getDate()+i),n=this._isBlockerVisible(e,r);return t.filter(n).sort(this._sortAppointmentsByStartHourCallBack)};S.prototype._isBlockerVisible=function(t,e){return function(i){var r=d.fromLocalJSDate(i.getStartDate()),n=d.fromLocalJSDate(i.getEndDate());var a=r.isBefore(t)&&n.isAfter(e),o=r.isSameOrAfter(t)&&r.isBefore(e),s=c._isBetween(n,t,e,true);return a||o||s}};S.prototype._calculateBlockersLevelsAndWidth=function(e){var i=0,r=new t.list;e.forEach(function(e){var n=new t.node(e),a=d.fromLocalJSDate(e.getStartDate()),o=d.fromLocalJSDate(e.getEndDate());n.width=c._daysBetween(o,a);if(r.getSize()===0){r.add(n);return}r.getIterator().forEach(function(t){var e=true,r=t.getData(),o=d.fromLocalJSDate(r.getStartDate()),s=d.fromLocalJSDate(r.getEndDate());if(a.isSameOrAfter(o)&&a.isBefore(s)){n.level++;i=Math.max(i,n.level)}if(t.next&&t.next.level===n.level){e=false}if(a.isSameOrAfter(s)&&e){this.interrupt()}});r.insertAfterLevel(n.level,n)},this);return{oBlockersList:r,iMaxlevel:i}};S.prototype._sortAppointmentsByStartHourCallBack=function(t,e){return t.getStartDate().getTime()-e.getStartDate().getTime()||e.getEndDate().getTime()-t.getEndDate().getTime()};S.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments};S.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender};S.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers};S.prototype._getBlockersToRender=function(){return this._oBlockersToRender};S.prototype._setColumns=function(t){this._iOldColumns=this._iColumns;this._iColumns=t;this.getAggregation("_columnHeaders").setDays(t);this.invalidate();return this};S.prototype._getColumns=function(){return this._iColumns};S.prototype._getRowHeight=function(){return this._isCompact()?D:f};S.prototype._getBlockerRowHeight=function(){return this._isCompact()?y:_};S.prototype._isCompact=function(){var t=this.getDomRef();while(t&&t.classList){if(t.classList.contains("sapUiSizeCompact")){return true}t=t.parentNode}return false};S.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};S.prototype._getCoreLocaleData=function(){var t,e;if(!this._oLocaleData){t=this._getCoreLocaleId();e=new r(t);this._oLocaleData=i.getInstance(e)}return this._oLocaleData};S.prototype._hasAMPM=function(){var t=this._getCoreLocaleData();return t.getTimePattern("short").search("a")>=0};S.prototype._getHoursFormat=function(){var t=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==t){var e=new r(t),i=this._getHoursPattern();this._oHoursFormat=a.getTimeInstance({pattern:i},e)}return this._oHoursFormat};S.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H"};S.prototype._getAMPMFormat=function(){var t=this._getCoreLocaleId(),e=new r(t);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==t){this._oAMPMFormat=a.getTimeInstance({pattern:"a"},e)}return this._oAMPMFormat};S.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders")};S.prototype._getAppointmentStartEndInfo=function(t){var e=this._oUnifiedRB.getText("CALENDAR_START_TIME"),i=this._oUnifiedRB.getText("CALENDAR_END_TIME"),r=this._oFormatAria.format(t.getStartDate()),n=this._oFormatAria.format(t.getEndDate());return e+": "+r+"; "+i+": "+n};S.prototype.enhanceAccessibilityState=function(t,e){if(t.getId()===this._getColumnHeaders().getId()){e.labelledby=n.getStaticId("sap.m","PLANNINGCALENDAR_DAYS")}};S.prototype.isAllDayAppointment=function(t,e){var i=t.getHours()===0,r=t.getMinutes()===0,n=t.getSeconds()===0,a=t.getMilliseconds()===0,o=i&&r&&n&&a,s=false;if(o){s=this._isEndTime0000(t,e)}return s};S.prototype._isEndTime0000=function(t,e){return(e.getTime()-t.getTime())%C===0};S.prototype._createBlockersDndPlaceholders=function(t,e){this.destroyAggregation("_blockersPlaceholders");for(var i=0;i<e;i++){var r=new o(t.getFullYear(),t.getMonth(),t.getDate()+i);var n=new M({date:r});this.addAggregation("_blockersPlaceholders",n,true)}};S.prototype._createAppointmentsDndPlaceholders=function(t,e){var i=this._getVisibleStartHour(),r=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var n=0;n<e;n++){var a=new d(t.getFullYear(),t.getMonth(),t.getDate()+n);if(!this._dndPlaceholdersMap[a]){this._dndPlaceholdersMap[a]=[]}for(var s=i;s<=r;s++){var l=this._dndPlaceholdersMap[a],p=a.getYear(),g=a.getMonth(),u=a.getDate();l.push(this._createAppointmentsDndPlaceHolder(new o(p,g,u,s)));l.push(this._createAppointmentsDndPlaceHolder(new o(p,g,u,s,30)))}}};S.prototype._createAppointmentsDndPlaceHolder=function(t){var e=new M({date:t});this.addAggregation("_intervalPlaceholders",e,true);return e};var M=e.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:function(t,e){t.write("<div");t.writeControlData(e);t.addClass("sapMSinglePCPlaceholder");t.writeClasses();t.write("></div>")}});return S});