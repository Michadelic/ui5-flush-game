/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/model/base/ManagedObjectModel","sap/m/Toolbar","sap/m/ResponsivePopover","sap/m/Button","sap/m/ToggleButton","sap/m/ToolbarSpacer","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/dom/containsOrEquals","sap/m/ColumnPopoverItem"],function(e,t,o,n,i,s,r,a,p,l,u){"use strict";var c=e.extend("sap.m.ColumnHeaderPopover",{library:"sap.m",metadata:{properties:{},aggregations:{items:{type:"sap.m.ColumnPopoverItem",multiple:true,singularName:"item",bindable:true},_popover:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},defaultAggregation:"items"}});c.prototype.init=function(){this._bPopoverCreated=false;this._oShownCustomContent=null};c.prototype._createPopover=function(){var e=this;this._oShownCustomContent=null;var s=sap.ui.getCore().getLibraryResourceBundle("sap.m"),u=s.getText("COLUMNHEADERPOPOVER_CLOSE_BUTTON");var c=new n({showArrow:false,showHeader:false,placement:"Bottom",verticalScrolling:true,horizontalScrolling:false,beforeClose:function(t){if(e._oShownCustomContent){e._oShownCustomContent.setVisible(false);e._oShownCustomContent=null}e._cleanSelection(this)}});this.setAggregation("_popover",c);var g=new o;g.bUseExtendedChangeDetection=true;c.addContent(g);var m=new a({path:"visible",operator:p.EQ,value1:true});var C=function(t,o){var n=o.getObject();var i;if(n.isA("sap.m.ColumnPopoverActionItem")){i=e._createActionItem(t,n)}else if(n.isA("sap.m.ColumnPopoverCustomItem")){i=e._createCustomItem(t,n)}n._sRelatedId=i.sId;i._sContentId=n._sContentId;i.destroy=function(){var t=this.getDomRef();if(t&&l(t,document.activeElement)){c.focus();c.removeContent(e._oShownCustomContent)}this.constructor.prototype.destroy.apply(this,arguments)};return i};g.bindAggregation("content",{path:"/items",filters:[m],length:5,factory:C});g.updateAggregation=function(e){if(this._oShownCustomContent){this._oShownCustomContent=null}o.prototype.updateAggregation.apply(this,arguments);var t=this.getContent();if(t.length<=2||!(t[t.length-2]instanceof r)){this.addContent(new r);this.addContent(new i({type:"Transparent",icon:"sap-icon://decline",tooltip:u,press:[c.close,c]}))}};var h=new t(this);g.setModel(h)};c.prototype._createActionItem=function(e,t){var o=this;return new i(e,{icon:"{icon}",tooltip:"{text}",type:"Transparent",press:function(){var e=o.getAggregation("_popover");if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false);o._oShownCustomContent=null;o._cleanSelection(e,this)}t.firePress()}})};c.prototype._createCustomItem=function(e,t){var o=this;var n=this.getAggregation("_popover");var i=t.getContent();if(i){i.setVisible(false);t._sContentId=i.sId}n.addContent(i);return new s(e,{icon:"{icon}",type:"Transparent",tooltip:"{text}",press:function(){if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false)}if(this.getPressed()){o._cleanSelection(n,this);t.fireBeforeShowContent();if(i){i.setVisible(true);o._oShownCustomContent=i}}else{if(i){i.setVisible(false);o._oShownCustomContent=null}}}})};c.prototype._cleanSelection=function(e,t){var o=e.getContent()[0],n;n=o.getContent();if(n){n.forEach(function(e){if((!t||e!==t)&&e.getPressed&&e.getPressed()){e.setPressed(false)}})}};c.prototype.openBy=function(e){if(!this._bPopoverCreated){this._createPopover();this._bPopoverCreated=true}var t=this.getAggregation("_popover");if(!this._bAppendedToUIArea&&!this.getParent()){var o=sap.ui.getCore().getStaticAreaRef();o=sap.ui.getCore().getUIArea(o);o.addContent(this,true);this._bAppendedToUIArea=true}var n=e.getFocusDomRef();if(n){t.setOffsetY(-n.clientHeight)}t.openBy(e)};c.prototype.invalidate=function(t){var o=this.getAggregation("_popover");if(t===o){e.prototype.invalidate.apply(this,arguments)}return this};return c});