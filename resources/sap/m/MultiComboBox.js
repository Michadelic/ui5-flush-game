/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./InputBase","./ComboBoxTextField","./ComboBoxBase","./Input","./Tokenizer","./Token","./ToggleButton","./List","./StandardListItem","./Popover","./SuggestionsPopover","./Toolbar","./GroupHeaderListItem","./library","sap/ui/core/EnabledPropagator","sap/ui/core/IconPool","sap/ui/core/library","sap/ui/Device","sap/ui/core/Item","sap/ui/core/SeparatorItem","sap/ui/core/ResizeHandler","./MultiComboBoxRenderer","sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/util/deepEqual","sap/base/assert","sap/base/Log","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/cursorPos","sap/ui/dom/jquery/control"],function(e,t,i,s,o,r,n,a,l,h,u,p,c,g,d,f,m,_,I,y,v,S,T,C,k,E,O,b,P){"use strict";var L=g.ListType;var B=g.ListMode;var V=m.ValueState;var A=m.OpenState;var x=g.PlacementType;var R=i.extend("sap.m.MultiComboBox",{metadata:{library:"sap.m",designtime:"sap/m/designtime/MultiComboBox.designtime",properties:{selectedKeys:{type:"string[]",group:"Data",defaultValue:[]}},associations:{selectedItems:{type:"sap.ui.core.Item",multiple:true,singularName:"selectedItem"}},events:{selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}},selectionFinish:{parameters:{selectedItems:{type:"sap.ui.core.Item[]"}}}}}});f.insertFontFaceStyle();d.apply(R.prototype,[true]);R.prototype.open=function(){this._bPickerIsOpening=true;i.prototype.open.apply(this,arguments)};R.prototype.onsapend=function(e){sap.m.Tokenizer.prototype.onsapend.apply(this._oTokenizer,arguments)};R.prototype.onsaphome=function(e){sap.m.Tokenizer.prototype.onsaphome.apply(this._oTokenizer,arguments)};R.prototype.onsapdown=function(e){if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[0];if(i&&this.isOpen()){this.getListItem(i).focus();return}if(this._oTokenizer.getSelectedTokens().length){return}this._oTraversalItem=this._getNextTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length)}};R.prototype.onsapup=function(e){if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();e.preventDefault();if(this._oTokenizer.getSelectedTokens().length){return}this._oTraversalItem=this._getPreviousTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length)}};R.prototype.onsapshow=function(e){var t=this._getList(),s=this.getPicker(),o=this.getSelectableItems(),r=this.getSelectedItems(),n,a=t.getItemNavigation(),l,h;h=P(document.activeElement).control()[0];if(h instanceof sap.m.Token){n=this._getItemByToken(h)}else{n=r.length?this._getItemByListItem(this._getList().getSelectedItems()[0]):o[0]}l=this.getItems().indexOf(n);if(a){a.setSelectedIndex(l)}else{this._bListItemNavigationInvalidated=true;this._iInitialItemFocus=l}s.setInitialFocus(t);i.prototype.onsapshow.apply(this,arguments)};R.prototype.onsaphide=R.prototype.onsapshow;R.prototype._selectItemByKey=function(e){var t,i,s,o,r,n=this.isOpen();if(!this.getEnabled()||!this.getEditable()){return}if(e){e.setMarked()}t=this._getUnselectedItems(n?"":this.getValue());for(o=0;o<t.length;o++){if(t[o].getText().toUpperCase()===this.getValue().toUpperCase()){s=t[o];r=true;break}}if(r){i={item:s,id:s.getId(),key:s.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false};this._bPreventValueRemove=false;if(this.getValue()===""||typeof this.getValue()==="string"&&s.getText().toLowerCase().startsWith(this.getValue().toLowerCase())){if(this.getListItem(s).isSelected()){this.setValue("")}else{this.setSelection(i)}}}else{if(this.isPickerDialog()){this._showAlreadySelectedVisualEffect()}this._bPreventValueRemove=true;this._showWrongValueVisualEffect()}if(e){this.close()}};R.prototype.onsapenter=function(t){e.prototype.onsapenter.apply(this,arguments);this._showAlreadySelectedVisualEffect();if(this.getValue()){this._selectItemByKey(t)}};R.prototype.onsaptabnext=function(e){var t=this.getValue();if(t){var i=this._getUnselectedItemsStartingText(t);if(i.length===1){this._selectItemByKey(e)}else{this._showWrongValueVisualEffect()}}};R.prototype.onsapfocusleave=function(e){var t=this.getAggregation("picker"),i=this.isPlatformTablet(),s=b.byId(e.relatedControlId),o=s&&s.getFocusDomRef(),n=this.getValue();if(!this._bPickerIsOpening&&(!t||!t.getFocusDomRef()||!o||!P.contains(t.getFocusDomRef(),o))){this.setValue(null);if(n){this.fireChangeEvent("",{value:n})}if(!(s instanceof r||e.srcControl instanceof r)){this._oTokenizer.scrollToEnd()}if(!P.contains(this.getDomRef(),document.activeElement)){this._oTokenizer._useCollapsedMode(true)}}if(t&&o){if(k(t.getFocusDomRef(),o)&&!i&&!this.isPickerDialog()){this.focus()}}};R.prototype.onfocusin=function(e){var t=this.getPicker();var i=false;var s=t.getFocusDomRef();var o=t.oPopup.getOpenState();var r=o===A.CLOSING||o===A.CLOSED;var n=this.getPickerType()==="Dropdown";if(n){i=s&&P.contains(s,e.relatedTarget)}if(this.getEditable()){this._oTokenizer._useCollapsedMode(false);this._oTokenizer.scrollToEnd()}if(e.target===this.getFocusDomRef()){this.getEditable()&&this.addStyleClass("sapMFocus");!r&&i&&this.handleInputValidation(e,false)}if(e.target===this.getOpenArea()&&n&&!this.isPlatformTablet()){this.focus()}if(!this.isOpen()&&this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}};R.prototype._handleItemTap=function(e){var t=P(e.target).control(0);if(!t.isA("sap.m.CheckBox")&&!t.isA("sap.m.GroupHeaderListItem")){this._bCheckBoxClicked=false}};R.prototype._handleItemPress=function(e){if(this.isOpen()&&this._isListInSuggestMode()&&this.getPicker().oPopup.getOpenState()!==A.CLOSING){this.clearFilter();var t=this._getLastSelectedItem();if(t){this.getListItem(t).focus()}}};R.prototype._handleSelectionLiveChange=function(e){var t=e.getParameter("listItem");var i=e.getParameter("selected");var s=this._getItemByListItem(t);var o=this.isPickerDialog()?this.getPickerTextField():this;if(t.getType()==="Inactive"){return}E(s,"The corresponding mapped item was not found on "+this);if(!s){return}var r={item:s,id:s.getId(),key:s.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:true};if(i){this.fireChangeEvent(s.getText());this.setSelection(r)}else{this.fireChangeEvent(s.getText());this.removeSelection(r)}if(this._bCheckBoxClicked){o.setValue(this._sOldInput);if(this.isOpen()&&this.getPicker().oPopup.getOpenState()!==A.CLOSING){t.focus()}}else{this._bCheckBoxClicked=true;this.setValue("");this.close()}};R.prototype.onkeydown=function(e){i.prototype.onkeydown.apply(this,arguments);if(!this.getEnabled()||!this.getEditable()){return}this._bIsPasteEvent=(e.ctrlKey||e.metaKey)&&e.which===C.V;if(this.getValue().length===0&&(e.ctrlKey||e.metaKey)&&e.which===C.A&&this._hasTokens()){this._oTokenizer.focus();this._oTokenizer.selectAllTokens(true);e.preventDefault()}if(this.isPickerDialog()){this._sOldValue=this.getPickerTextField().getValue();this._iOldCursorPos=P(this.getFocusDomRef()).cursorPos()}this._bDoTypeAhead=e.which!==C.BACKSPACE&&e.which!==C.DELETE};R.prototype.oninput=function(e){i.prototype.oninput.apply(this,arguments);var t=e.srcControl,s=this.getPickerTextField();if(this.isPickerDialog()&&s.getValueState()===V.Error){s.setValueState(V.None)}if(!this.getEnabled()||!this.getEditable()){return}if(this._bIsPasteEvent){t.updateDomValue(this._sOldValue||"");return}this.handleInputValidation(e,this.isComposingCharacter());if(this.isOpen()){setTimeout(this._highlightList.bind(this,this._sOldInput))}};R.prototype.filterItems=function(e){var t=this.fnFilter?this.fnFilter:i.DEFAULT_TEXT_FILTER;var s=[];var o=false;var r=[];e.items.forEach(function(i){if(i.isA("sap.ui.core.SeparatorItem")){r.push({separator:i});this.getListItem(i).setVisible(false);o=true;return}var n=!!t(e.value,i,"getText");if(e.value===""){n=true;if(!this.bOpenedByKeyboardOrButton&&!this.isPickerDialog()){return}}if(o&&n){this.getListItem(r[r.length-1].separator).setVisible(true)}var a=this.getListItem(i);if(a){a.setVisible(n);n&&s.push(i)}},this);return s};R.prototype.onkeyup=function(e){if(!this.getEnabled()||!this.getEditable()){return}this._sOldValue=this.getValue();this._iOldCursorPos=P(this.getFocusDomRef()).cursorPos()};R.prototype._showWrongValueVisualEffect=function(){var e=this.getPickerTextField(),t=this.isPickerDialog()?e.getValueState():this.getValueState(),i=this._oRbC.getText("VALUE_STATE_ERROR");if(t===V.Error){return}if(this.isPickerDialog()){e.setValueState(V.Error);e.setValueStateText(i);setTimeout(e["setValueState"].bind(e,t),1e3)}else{this.setValueState(V.Error);this.setValueStateText(i);setTimeout(this["setValueState"].bind(this,t),1e3)}};R.prototype._showAlreadySelectedVisualEffect=function(){var e=this.isPickerDialog(),t=this.getPickerTextField(),i=e?t.getValueState():this.getValueState(),s=this.getValue().toLowerCase(),o=this.getSelectedItems().map(function(e){return e.getText().toLowerCase()}),r=this._oRbM.getText("VALUE_STATE_ERROR_ALREADY_SELECTED");if(o.indexOf(s)>-1&&i!==V.Error){if(e){t.setValueState(V.Error);t.setValueStateText(r);t.selectText(0,this.getValue().length)}else{this.setValueState(V.Error);this.setValueStateText(r);this.selectText(0,this.getValue().length)}}else{e?t.setValueState(V.None):this.setValueState(V.None)}};R.prototype._getReadOnlyPopover=function(){if(!this._oReadOnlyPopover){this._oReadOnlyPopover=this._createReadOnlyPopover()}return this._oReadOnlyPopover};R.prototype._createReadOnlyPopover=function(){return new h({showArrow:true,placement:x.Auto,showHeader:false,contentMinWidth:"auto"}).addStyleClass("sapMMultiComboBoxReadOnlyPopover")};R.prototype.createPicker=function(e){var t=this.getAggregation("picker"),i=this.getRenderer(),s=i.CSS_CLASS_MULTICOMBOBOX;if(t){return t}this._oSuggestionPopover=this._createSuggestionsPopover();t=this._oSuggestionPopover._oPopover;this.setAggregation("picker",t,true);this["configure"+e](t);t.setHorizontalScrolling(false).addStyleClass(i.CSS_CLASS_COMBOBOXBASE+"Picker").addStyleClass(s+"Picker").addStyleClass(s+"Picker-CTX").attachBeforeOpen(this.onBeforeOpen,this).attachAfterOpen(this.onAfterOpen,this).attachBeforeClose(this.onBeforeClose,this).attachAfterClose(this.onAfterClose,this).addEventDelegate({onBeforeRendering:this.onBeforeRenderingPicker,onAfterRendering:this.onAfterRenderingPicker},this);return t};R.prototype._createSuggestionsPopover=function(){var e=this.isPickerDialog(),t;t=new u(this);if(e){t._oPopupInput=this._createPickerTextField()}t._createSuggestionPopup();t._createSuggestionPopupContent(false,false,false);this._oList=t._oList;this._configureList(this._oList);return t};R.prototype._configureList=function(e){var t=this.getRenderer();if(!e){return}e.setMode(B.MultiSelect).setIncludeItemInSelection(true).setRememberSelections(false).addStyleClass(t.CSS_CLASS_COMBOBOXBASE+"List").addStyleClass(t.CSS_CLASS_MULTICOMBOBOX+"List");e.attachBrowserEvent("tap",this._handleItemTap,this).attachSelectionChange(this._handleSelectionLiveChange,this).attachItemPress(this._handleItemPress,this);e.addEventDelegate({onAfterRendering:this.onAfterRenderingList,onfocusin:this.onFocusinList},this)};R.prototype._createPickerTextField=function(){var e=this;return new s({submit:function(t){var i=this.getValue();if(i){e.setValue(i);e._selectItemByKey();this.setValue(e._sOldInput)}}}).addEventDelegate({onfocusout:this._handleInputFocusOut},this)};R.prototype.onBeforeRendering=function(){i.prototype.onBeforeRendering.apply(this,arguments);var e=this.getItems(),t=this._getList();if(t){this._synchronizeSelectedItemAndKey(e);t.destroyItems();this._clearTokenizer();this._fillList(e);if(t.getItemNavigation()){this._iFocusedIndex=t.getItemNavigation().getFocusedIndex()}this.setEditable(this.getEditable())}this._deregisterResizeHandler()};R.prototype._registerResizeHandler=function(){E(!this._iResizeHandlerId,"Resize handler already registered");this._iResizeHandlerId=v.register(this,this._onResize.bind(this))};R.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){v.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null}};R.prototype._onResize=function(){this._oTokenizer.setMaxWidth(this._calculateSpaceForTokenizer())};R.prototype.onBeforeRenderingPicker=function(){var e=this["_onBeforeRendering"+this.getPickerType()];if(e){e.call(this)}};R.prototype.onAfterRenderingPicker=function(){var e=this["_onAfterRendering"+this.getPickerType()];if(e){e.call(this)}};R.prototype.onBeforeOpen=function(){var t=this["_onBeforeOpen"+this.getPickerType()];this.addStyleClass(e.ICON_PRESSED_CSS_CLASS);this._resetCurrentItem();this.addContent();this._aInitiallySelectedItems=this.getSelectedItems();this._synchronizeSelectedItemAndKey(this._aInitiallySelectedItems);if(t){t.call(this)}};R.prototype.onAfterOpen=function(){var e=this.getFocusDomRef();e&&this.getRoleComboNodeDomRef().setAttribute("aria-expanded","true");this._bPickerIsOpening=false;if(!this.isPlatformTablet()){this.getPicker().setInitialFocus(this)}this.closeValueStateMessage()};R.prototype.onBeforeClose=function(){i.prototype.onBeforeClose.apply(this,arguments)};R.prototype.onAfterClose=function(){var t=!P.contains(this.getDomRef(),document.activeElement)||this.isPickerDialog(),i=this.getFocusDomRef();i&&this.getRoleComboNodeDomRef().setAttribute("aria-expanded","false");this.removeStyleClass(e.ICON_PRESSED_CSS_CLASS);this.clearFilter();!this.isComposingCharacter()&&!this._bPreventValueRemove&&this.setValue("");this._sOldValue="";this._sOldInput="";if(this.isPickerDialog()){this._showAlreadySelectedVisualEffect();this.getPickerTextField().setValue("");this._getFilterSelectedButton()&&this._getFilterSelectedButton().setPressed(false)}this.fireSelectionFinish({selectedItems:this.getSelectedItems()});this._oTokenizer._useCollapsedMode(t);if(this.getValueState()==V.Error&&document.activeElement===this.getFocusDomRef()){this.selectText(0,this.getValue().length);this.openValueStateMessage()}};R.prototype._onBeforeOpenDialog=function(){};R.prototype._onBeforeOpenDropdown=function(){var e=this.getPicker(),t=this.getDomRef(),i;if(t&&e){i=t.offsetWidth/parseFloat(g.BaseFontSize)+"rem";e.setContentMinWidth(i)}};R.prototype.configureDropdown=function(e){e.setInitialFocus(this)};R.prototype.getFilterSelectedButton=function(){if(this._oToggleButton){return this._oToggleButton}this._oToggleButton=this._createFilterSelectedButton();return this._oToggleButton};R.prototype.getPickerCustomHeader=function(){if(this._oPickerCustomHeader){return this._oPickerCustomHeader}this._oPickerCustomHeader=this.createPickerHeader();return this._oPickerCustomHeader};R.prototype.getCustomHeaderToolbar=function(){if(this._oCustomHeaderToolbar){return this._oCustomHeaderToolbar}this._oCustomHeaderToolbar=new p;return this._oCustomHeaderToolbar};R.prototype.getPickerCloseButton=function(){if(this._oPickerCloseButton){return this._oPickerCloseButton}this._oPickerCloseButton=this.createPickerCloseButton();return this._oPickerCloseButton};R.prototype.configureDialog=function(e){var t=this,i=this.getFilterSelectedButton(),s=this._oSuggestionPopover._oPopupInput,o=s._handleEvent,r=this.getCustomHeaderToolbar(),n=this.getPickerInvisibleTextId();r.addContent(s);s._handleEvent=function(e){o.apply(this,arguments);if(/keydown|sapdown|sapup|saphome|sapend|sappagedown|sappageup|input/.test(e.type)){t._handleEvent(e)}};e.setStretch(true);e.setCustomHeader(this.getPickerCustomHeader());e.setSubHeader(r);e.addButton(this.createPickerCloseButton());e.getSubHeader().addContent(i);e.attachBeforeOpen(function(){t.updatePickerHeaderTitle()});e.attachAfterClose(function(){t.focus();g.closeKeyboard()});if(n){e.addAriaLabelledBy(n)}};R.prototype._createFilterSelectedButton=function(){if(this._oToggleButton){return this._oToggleButton}var e=f.getIconURI("multiselect-all"),t=this.getRenderer(),i=this;this._oToggleButton=new n({icon:e,press:i._filterSelectedItems.bind(this)}).addStyleClass(t.CSS_CLASS_MULTICOMBOBOX+"ToggleButton");return this._oToggleButton};R.prototype._getFilterSelectedButton=function(){return this.getPicker().getSubHeader().getContent()[1]};R.prototype._filterSelectedItems=function(e,t){var i=e.oSource,s,o,r=this.getPickerTextField()?this.getPickerTextField().getValue():"",n=i&&i.getPressed&&i.getPressed()||t,a=this.getVisibleItems(),l=this.getItems(),h=this.getSelectedItems(),u=null;if(n){a.forEach(function(e){o=h.indexOf(e)>-1?true:false;s=this.getListItem(e);if(!s){return}if(s.isA("sap.m.GroupHeaderListItem")){s.setVisible(false);u=s}else{s.setVisible(o);if(o&&u){u.setVisible(true)}}},this)}else{this.filterItems({value:r,items:l})}};R.prototype.revertSelection=function(){this.setSelectedItems(this._aInitiallySelectedItems)};R.prototype.setSelection=function(e){if(e.item&&this.isItemSelected(e.item)){return}if(!e.item){return}if(!e.listItemUpdated&&this.getListItem(e.item)){this._getList().setSelectedItem(this.getListItem(e.item),true)}var t=new sap.m.Token({key:e.key});t.setText(e.item.getText());t.setTooltip(e.item.getText());e.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",t);this._oTokenizer.addToken(t);this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());this.setValue("");this.addAssociation("selectedItems",e.item,e.suppressInvalidate);var i=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",i,e.suppressInvalidate);if(e.fireChangeEvent){this.fireSelectionChange({changedItem:e.item,selected:true})}if(e.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()})}}};R.prototype.removeSelection=function(e){if(e.item&&!this.isItemSelected(e.item)){return}if(!e.item){return}this.removeAssociation("selectedItems",e.item,e.suppressInvalidate);var t=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",t,e.suppressInvalidate);if(!e.listItemUpdated&&this.getListItem(e.item)){var i=this.getListItem(e.item);this._getList().setSelectedItem(i,false)}if(!e.tokenUpdated){var s=this._getTokenByItem(e.item);e.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",null);this._oTokenizer.removeToken(s)}this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());if(e.fireChangeEvent){this.fireSelectionChange({changedItem:e.item,selected:false})}if(e.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()})}}};R.prototype._synchronizeSelectedItemAndKey=function(e){if(!e.length){O.info("Info: _synchronizeSelectedItemAndKey() the MultiComboBox control does not contain any item on ",this);return}var t=this.getSelectedKeys()||this._aCustomerKeys;var i=this.getKeys(this.getSelectedItems());if(t.length){for(var s=0,o=null,r=null,n=null,a=t.length;s<a;s++){o=t[s];if(i.indexOf(o)>-1){if(this._aCustomerKeys.length&&(n=this._aCustomerKeys.indexOf(o))>-1){this._aCustomerKeys.splice(n,1)}continue}r=this.getItemByKey(""+o);if(r){if(this._aCustomerKeys.length&&(n=this._aCustomerKeys.indexOf(o))>-1){this._aCustomerKeys.splice(n,1)}this.setSelection({item:r,id:r.getId(),key:r.getKey(),fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:false})}}return}};R.prototype._getTokenByItem=function(e){return e?e.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token"):null};R.prototype.updateItems=function(e){var t,s,o=this.getSelectedKeys();var r=i.prototype.updateItems.apply(this,arguments);s=this.getSelectedItems();t=s.length===o.length&&s.every(function(e){return e&&e.getKey&&o.indexOf(e.getKey())>-1});if(!t){s=o.map(this.getItemByKey,this);this.setSelectedItems(s)}return r};R.prototype._getSelectedItemsOf=function(e){for(var t=0,i=e.length,s=[];t<i;t++){if(this.getListItem(e[t]).isSelected()){s.push(e[t])}}return s};R.prototype._getLastSelectedItem=function(){var e=this._oTokenizer.getTokens();var t=e.length?e[e.length-1]:null;if(!t){return null}return this._getItemByToken(t)};R.prototype._getOrderedSelectedItems=function(){var e=[];for(var t=0,i=this._oTokenizer.getTokens(),s=i.length;t<s;t++){e[t]=this._getItemByToken(i[t])}return e};R.prototype._getFocusedListItem=function(){if(!document.activeElement){return null}var e=b.byId(document.activeElement.id);if(this._getList()&&T(this._getList().getFocusDomRef(),e.getFocusDomRef())){return e}return null};R.prototype._getFocusedItem=function(){var e=this._getFocusedListItem();return this._getItemByListItem(e)};R.prototype._isRangeSelectionSet=function(e){var t=e.getDomRef();return t.indexOf(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"ItemRangeSelection")>-1?true:false};R.prototype._hasTokens=function(){return this._oTokenizer.getTokens().length>0};R.prototype._getCurrentItem=function(){if(!this._oCurrentItem){return this._getFocusedItem()}return this._oCurrentItem};R.prototype._setCurrentItem=function(e){this._oCurrentItem=e};R.prototype._resetCurrentItem=function(){this._oCurrentItem=null};R.prototype._decorateListItem=function(e){e.addDelegate({onkeyup:function(e){var t=null;if(e.which==C.SPACE&&this.isOpen()&&this._isListInSuggestMode()){this.open();t=this._getLastSelectedItem();if(t){this.getListItem(t).focus()}return}},onkeydown:function(e){var t=null,i=null;if(e.shiftKey&&e.which==C.ARROW_DOWN){i=this._getCurrentItem();t=this._getNextVisibleItemOf(i)}if(e.shiftKey&&e.which==C.ARROW_UP){i=this._getCurrentItem();t=this._getPreviousVisibleItemOf(i)}if(e.shiftKey&&e.which===C.SPACE){i=this._getCurrentItem();this._selectPreviousItemsOf(i)}if(t&&t!==i){if(this.getListItem(i).isSelected()){this.setSelection({item:t,id:t.getId(),key:t.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(t)}else{this.removeSelection({item:t,id:t.getId(),key:t.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(t)}return}this._resetCurrentItem();if((e.ctrlKey||e.metaKey)&&e.which==C.A){e.setMarked();e.preventDefault();var s=this.getSelectableItems();var o=this._getSelectedItemsOf(s);if(o.length!==s.length){s.forEach(function(e){this.setSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false})},this)}else{s.forEach(function(e){this.removeSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false})},this)}}}},true,this);e.addEventDelegate({onsapbackspace:function(e){e.preventDefault()},onsapshow:function(e){e.setMarked();if(this.isOpen()){this.close();return}if(this.hasContent()){this.open()}},onsaphide:function(e){this.onsapshow(e)},onsapenter:function(e){e.setMarked();this.close()},onsaphome:function(e){e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[0];this.getListItem(i).focus()},onsapend:function(e){e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[t.length-1];this.getListItem(i).focus()},onsapup:function(e){e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[0];var s=P(document.activeElement).control()[0];if(s===this.getListItem(i)){this.focus();e.stopPropagation(true)}},onfocusin:function(e){this.addStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused")},onfocusout:function(e){this.removeStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused")},onsapfocusleave:function(e){var t=this.getAggregation("picker");var i=b.byId(e.relatedControlId);if(t&&i&&k(t.getFocusDomRef(),i.getFocusDomRef())){if(e.srcControl){e.srcControl.focus()}}}},this);if(_.support.touch){e.addEventDelegate({ontouchstart:function(e){e.setMark("cancelAutoClose")}})}};R.prototype._handleInputFocusOut=function(){var e=this.isPickerDialog()?this.getPickerTextField():this,t=this._sOldInput||this._sOldValue||"";e.updateDomValue(t)};R.prototype._handleIndicatorPress=function(e){this._filterSelectedItems(e,true);this.focus();if(this.getEditable()){this.getPicker().open()}else{this._getReadOnlyPopover().openBy(this._oTokenizer._oIndicator)}if(this.isPickerDialog()){this._getFilterSelectedButton().setPressed(true);this.bOpenedByKeyboardOrButton=true}else{setTimeout(this._oTokenizer["scrollToEnd"].bind(this._oTokenizer),0)}};R.prototype._createTokenizer=function(){var e=new sap.m.Tokenizer({tokens:[]}).attachTokenChange(this._handleTokenChange,this);e._setAdjustable(true);e._handleNMoreIndicatorPress(this._handleIndicatorPress.bind(this));e.setParent(this);e.addEventDelegate({onAfterRendering:this._onAfterRenderingTokenizer,onfocusin:function(t){if(this.getEditable()&&P(t.target).hasClass("sapMToken")){e._useCollapsedMode(false)}}},this);return e};R.prototype._onAfterRenderingTokenizer=function(){setTimeout(this._oTokenizer["scrollToEnd"].bind(this._oTokenizer),0)};R.prototype._handleTokenChange=function(e){var t=e.getParameter("type");var i=e.getParameter("token");var s=null;if(t!==sap.m.Tokenizer.TokenChangeType.Removed&&t!==sap.m.Tokenizer.TokenChangeType.Added){return}if(t===sap.m.Tokenizer.TokenChangeType.Removed){s=i&&this._getItemByToken(i);if(s&&this.isItemSelected(s)){this.removeSelection({item:s,id:s.getId(),key:s.getKey(),tokenUpdated:true,fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true});!this.isPickerDialog()&&this.focus();this.fireChangeEvent("")}}};R.prototype.onAfterRenderingList=function(){var e=this._getList();if(this._iFocusedIndex!=null&&e.getItems().length>this._iFocusedIndex){e.getItems()[this._iFocusedIndex].focus();this._iFocusedIndex=null}};R.prototype._highlightList=function(e){var t=[],i=[],s,o;this._getList().getItems().forEach(function(e){o=e.getDomRef();if(o){t.push({ref:o.getElementsByClassName("sapMSLITitleOnly")[0],text:e.getTitle()});s=o.querySelector(".sapMSLIInfo");if(s&&e.getInfo){i.push({ref:s,text:e.getInfo()})}}});this.highLightList(e,t);this.highLightList(e,i)};R.prototype.onFocusinList=function(){if(this._bListItemNavigationInvalidated){this._getList().getItemNavigation().setSelectedIndex(this._iInitialItemFocus);this._bListItemNavigationInvalidated=false}};R.prototype.onAfterRendering=function(){i.prototype.onAfterRendering.apply(this,arguments);this._oTokenizer.setMaxWidth(this._calculateSpaceForTokenizer());this._registerResizeHandler()};R.prototype.onfocusout=function(e){this.isOpen()&&this._handleInputFocusOut();this.removeStyleClass("sapMFocus");if(this.getValueState()===V.Error&&this.getValueStateText()===this._oRbM.getText("VALUE_STATE_ERROR_ALREADY_SELECTED")){this.setValueState(V.None)}i.prototype.onfocusout.apply(this,arguments)};R.prototype.onpaste=function(e){var t;if(window.clipboardData){t=window.clipboardData.getData("Text")}else{t=e.originalEvent.clipboardData.getData("text/plain")}var i=this._oTokenizer._parseString(t);if(i&&i.length>0){this.getSelectableItems().forEach(function(e){if(i.indexOf(e.getText())>-1){this.setSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false})}},this)}};R.prototype.onsapbackspace=function(e){this._showAlreadySelectedVisualEffect();if(!this.getEnabled()||!this.getEditable()){e.preventDefault();return}if(this.getCursorPosition()>0||this.getValue().length>0){return}sap.m.Tokenizer.prototype.onsapbackspace.apply(this._oTokenizer,arguments);e.preventDefault()};R.prototype.onsapdelete=function(e){this._showAlreadySelectedVisualEffect();if(!this.getEnabled()||!this.getEditable()){return}if(this.getValue()&&!this._isCompleteTextSelected()){return}sap.m.Tokenizer.prototype.onsapdelete.apply(this._oTokenizer,arguments)};R.prototype.onsapnext=function(e){if(e.isMarked()){return}var t=P(document.activeElement).control()[0];if(!t){return}if(t===this._oTokenizer||this._oTokenizer.$().find(t.$()).length>0&&this.getEditable()){this.focus()}};R.prototype.onsapprevious=function(e){if(this.getCursorPosition()===0&&!this._isCompleteTextSelected()){if(e.srcControl===this){sap.m.Tokenizer.prototype.onsapprevious.apply(this._oTokenizer,arguments)}}};R.prototype.ontap=function(e){i.prototype.ontap.apply(this,arguments);var t=this.getOpenArea();if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();if(this.isPickerDialog()&&t.contains(e.target)){this.open()}};R.prototype.getOpenArea=function(){if(this.isPickerDialog()){return this.getDomRef()}else{return i.prototype.getOpenArea.apply(this,arguments)}};R.prototype._getItemsStartingWithPerTerm=function(e,t){var s=[],o=t?this.getEnabledItems():this.getSelectableItems(),r=this.fnFilter?this.fnFilter:i.DEFAULT_TEXT_FILTER;o.forEach(function(t){if(r(e,t,"getText")){s.push(t)}},this);return s};R.prototype._getItemsStartingWith=function(e,t){var i=[],s=t?this.getEnabledItems():this.getSelectableItems();s.forEach(function(t){if(typeof e==="string"&&e!==""&&t.getText().toLowerCase().startsWith(e.toLowerCase())){i.push(t)}},this);return i};R.prototype._getUnselectedItemsStartingText=function(e){var t=[];this._getUnselectedItems().forEach(function(i){if(typeof e==="string"&&e!==""&&i.getText().toLowerCase().startsWith(e.toLowerCase())){t.push(i)}},this);return t};R.prototype.getCursorPosition=function(){return this._$input.cursorPos()};R.prototype._isCompleteTextSelected=function(){if(!this.getValue().length){return false}var e=this._$input[0];if(e.selectionStart!==0||e.selectionEnd!==this.getValue().length){return false}return true};R.prototype._selectPreviousItemsOf=function(e){var t;do{t=true;var i=this._getPreviousVisibleItemOf(e);if(i){var s=this.getListItem(i);if(s){t=this.getListItem(i).getSelected()}}this.setSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true});e=i}while(!t)};R.prototype._getNextVisibleItemOf=function(e){var t=this.getSelectableItems();var i=t.indexOf(e)+1;if(i<=0||i>t.length-1){return null}return t[i]};R.prototype._getPreviousVisibleItemOf=function(e){var t=this.getSelectableItems();var i=t.indexOf(e)-1;if(i<0){return null}return t[i]};R.prototype._getNextUnselectedItemOf=function(e){var t=this._getUnselectedItems();var i=t.indexOf(e)+1;if(i<=0||i>t.length-1){return null}return t[i]};R.prototype._getPreviousUnselectedItemOf=function(e){var t=this._getUnselectedItems();var i=t.indexOf(e)-1;if(i<0){return null}return t[i]};R.prototype._getNextTraversalItem=function(){var e=this.getValue();var t=e?this._getItemsStartingWithPerTerm(e):[];var i=this._getUnselectedItems();if(t.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getNextUnselectedItemOf(this._oTraversalItem)}if(t.length&&t[0].getText()===this.getValue()){return this._getNextUnselectedItemOf(t[0])}return t.length?t[0]:i[0]};R.prototype._getPreviousTraversalItem=function(){var e=this.getValue();var t=e?this._getItemsStartingWithPerTerm(e):[];if(t.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getPreviousUnselectedItemOf(this._oTraversalItem)}if(t.length&&t[t.length-1].getText()===this.getValue()){return this._getPreviousUnselectedItemOf(t[t.length-1])}if(t.length){return t[t.length-1]}else{var i=this._getUnselectedItems();if(i.length>0){return i[i.length-1]}else{return null}}};R.prototype.setSelectedItems=function(e){this.removeAllSelectedItems();if(!e||!e.length){return this}if(!Array.isArray(e)){O.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return this}e.forEach(function(e){if(!(e instanceof I)&&typeof e!=="string"){O.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return}if(typeof e==="string"){e=b.byId(e)}this.setSelection({item:e?e:null,id:e?e.getId():"",key:e?e.getKey():"",suppressInvalidate:true})},this);return this};R.prototype.addSelectedItem=function(e){if(!e){return this}if(typeof e==="string"){e=b.byId(e)}this.setSelection({item:e?e:null,id:e?e.getId():"",key:e?e.getKey():"",fireChangeEvent:false,suppressInvalidate:true});return this};R.prototype.removeSelectedItem=function(e){if(!e){return null}if(typeof e==="string"){e=b.byId(e)}if(!this.isItemSelected(e)){return null}this.removeSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:false,suppressInvalidate:true});return e};R.prototype.removeAllSelectedItems=function(){var e=[];var t=this.getAssociation("selectedItems",[]);t.forEach(function(t){var i=this.removeSelectedItem(t);if(i){e.push(i.getId())}},this);return e};R.prototype.removeSelectedKeys=function(e){var t=[],i;if(!e||!e.length||!Array.isArray(e)){return t}var s;e.forEach(function(e){s=this.getItemByKey(e);if(s){this.removeSelection({item:s?s:null,id:s?s.getId():"",key:s?s.getKey():"",fireChangeEvent:false,suppressInvalidate:true});t.push(s)}if(this._aCustomerKeys.length&&(i=this._aCustomerKeys.indexOf(e))>-1){this._aCustomerKeys.splice(i,1)}},this);return t};R.prototype.setSelectedKeys=function(e){this.removeAllSelectedItems();this._aCustomerKeys=[];this.addSelectedKeys(e);return this};R.prototype.addSelectedKeys=function(e){e=this.validateProperty("selectedKeys",e);e.forEach(function(e){var t=this.getItemByKey(e);if(t){this.addSelectedItem(t)}else if(e!=null){this._aCustomerKeys.push(e)}},this);return this};R.prototype.getSelectedKeys=function(){var e=this.getSelectedItems()||[],t=[];e.forEach(function(e){t.push(e.getKey())},this);if(this._aCustomerKeys.length){t=t.concat(this._aCustomerKeys)}return t};R.prototype._getUnselectedItems=function(){var e=P(this.getSelectableItems()).not(this.getSelectedItems()).get();if(!this.isOpen()){return e.filter(function(e){return!e.isA("sap.ui.core.SeparatorItem")})}return e};R.prototype.getSelectedItems=function(){var e=[],t=this.getAssociation("selectedItems")||[];t.forEach(function(t){var i=b.byId(t);if(i){e.push(i)}},this);return e};R.prototype.getWidth=function(){return this.getProperty("width")||"100%"};R.prototype.setEditable=function(e){var t=this._getList();i.prototype.setEditable.apply(this,arguments);this._oTokenizer.setEditable(e);if(e){t.setMode(B.MultiSelect);this.getPicker().addContent(t)}else{t.setMode(B.None);this._getReadOnlyPopover().addContent(t)}return this};R.prototype._mapItemToListItem=function(e){var t,i,s,o;var n=this.getRenderer();if(!e){return null}o=e.getAdditionalText&&this.getShowSecondaryValues()?e.getAdditionalText():"";if(e.isA("sap.ui.core.SeparatorItem")){t=this._mapSeparatorItemToGroupHeader(e,n);e.data(n.CSS_CLASS_COMBOBOXBASE+"ListItem",t);this._decorateListItem(t);return t}i=n.CSS_CLASS_MULTICOMBOBOX+"Item";s=this.isItemSelected(e)?i+"Selected":"";t=new l({type:L.Active,info:o,visible:e.getEnabled()}).addStyleClass(i+" "+s);t.setTooltip(e.getTooltip());e.data(n.CSS_CLASS_COMBOBOXBASE+"ListItem",t);t.setTitle(e.getText());if(s){var a=new r({key:e.getKey()});a.setText(e.getText());a.setTooltip(e.getText());e.data(n.CSS_CLASS_COMBOBOXBASE+"Token",a);this._oTokenizer.addToken(a,true)}this.setSelectable(e,e.getEnabled());this._decorateListItem(t);return t};R.prototype._findMappedItem=function(e,t){for(var i=0,t=t||this.getItems(),s=t.length;i<s;i++){if(this.getListItem(t[i])===e){return t[i]}}return null};R.prototype.setSelectable=function(e,t){if(this.indexOfItem(e)<0){return}e._bSelectable=t;var i=this.getListItem(e);if(i){i.setVisible(t)}var s=this._getTokenByItem(e);if(s){s.setVisible(t)}};R.prototype._fillList=function(e){if(!e){return null}if(!this._oListItemEnterEventDelegate){this._oListItemEnterEventDelegate={onsapenter:function(e){if(e.srcControl.isSelected()){e.setMarked()}}}}for(var t=0,i,s=e.length;t<s;t++){i=this._mapItemToListItem(e[t]);i.removeEventDelegate(this._oListItemEnterEventDelegate);i.addDelegate(this._oListItemEnterEventDelegate,true,this,true);this._getList().addAggregation("items",i,true);if(this.isItemSelected(e[t])){this._getList().setSelectedItem(i,true)}}};R.prototype.handleInputValidation=function(e,t){var i=e.target.value,s=this._sOldInput&&this._sOldInput.length>i.length,o=this.isValueValid(i),r,n,a;var l=e.srcControl;if(!o&&i!==""&&!t){this._handleFieldValidationState(l);return}a=this._getItemsStartingWith(i,true);!t&&this._handleTypeAhead(i,a,l);r=this.getEnabledItems();if(this.isPickerDialog()){n=this._getFilterSelectedButton();if(n!=null&&n.getPressed()){n.setPressed(false)}}if(s){r=this.getItems()}this.filterItems({value:i,items:r});this._sOldInput=i;if((!this.getValue()||!o)&&!this.bOpenedByKeyboardOrButton&&!this.isPickerDialog()){this.close()}else{this.open()}};R.prototype.isValueValid=function(e){var t=this._getItemsStartingWith(e,true);var i=this._getItemsStartingWithPerTerm(e,true);return t.length||i.length};R.prototype._handleTypeAhead=function(e,t,i){var s=this.getSelectedItems();var o=t.filter(function(e){if(e.isA("sap.ui.core.SeparatorItem")){return false}return s.indexOf(e)===-1});if(this._bDoTypeAhead&&o.length){i.updateDomValue(o[0].getText());if(document.activeElement===i.getFocusDomRef()){i.selectText(e.length,i.getValue().length)}}};R.prototype._handleFieldValidationState=function(e){if(this._sOldInput&&this.isValueValid(this._sOldInput)){e.updateDomValue(this._sOldInput)}else if(this._sOldValue&&this.isValueValid(this._sOldValue)){e.updateDomValue(this._sOldValue)}else{e.updateDomValue("")}if(this._iOldCursorPos){P(e.getFocusDomRef()).cursorPos(this._iOldCursorPos)}this._showWrongValueVisualEffect()};R.prototype.init=function(){this._oRb=b.getLibraryResourceBundle("sap.m");i.prototype.init.apply(this,arguments);this._bListItemNavigationInvalidated=false;this._iInitialItemFocus=-1;this._bCheckBoxClicked=true;this._bPreventValueRemove=false;this._oTokenizer=this._createTokenizer();this._aCustomerKeys=[];this._aInitiallySelectedItems=[];this._oRbM=b.getLibraryResourceBundle("sap.m");this._oRbC=b.getLibraryResourceBundle("sap.ui.core");this._fillList()};R.prototype.clearSelection=function(){this.removeAllSelectedItems()};R.prototype.insertItem=function(e,t){this.insertAggregation("items",e,t,true);if(e){e.attachEvent("_change",this.onItemChange,this)}if(this._getList()){this._getList().insertItem(this._mapItemToListItem(e),t)}return this};R.prototype.removeItem=function(e){e=this.removeAggregation("items",e);if(this._getList()){this._getList().removeItem(e&&this.getListItem(e))}this.removeSelection({item:e,id:e?e.getId():"",key:e?e.getKey():"",fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:true});return e};R.prototype.isItemSelected=function(e){return this.getSelectedItems().indexOf(e)>-1};R.prototype._clearTokenizer=function(){this._oTokenizer.destroyAggregation("tokens",true)};R.prototype.exit=function(){var e=["_oTokenizer","_oSuggestionPopover","_oToggleButton","_oPickerCustomHeader","_oCustomHeaderToolbar","_oPickerCloseButton"],t=this;i.prototype.exit.apply(this,arguments);this._deregisterResizeHandler();e.forEach(function(e){if(t[e]){t[e].destroy();t[e]=null}})};R.prototype.destroyItems=function(){this.destroyAggregation("items");if(this._getList()){this._getList().destroyItems()}this._oTokenizer.destroyTokens();return this};R.prototype.removeAllItems=function(){var e=this.removeAllAggregation("items");this.removeAllSelectedItems();if(this._getList()){this._getList().removeAllItems()}return e};R.prototype._getItemByToken=function(e){return this._getItemBy(e,"Token")};R.prototype.getAccessibilityInfo=function(){var e=this.getSelectedItems().map(function(e){return e.getText()}).join(" ");var t=i.prototype.getAccessibilityInfo.apply(this,arguments);t.type=b.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_MULTICOMBO");t.description=((t.description||"")+" "+e).trim();return t};R.prototype.applyShowItemsFilters=function(){this.filterItems({value:this.getValue()||"_",items:this.getItems()})};return R});