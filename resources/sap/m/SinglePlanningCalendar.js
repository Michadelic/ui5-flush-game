/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","./PlanningCalendarHeader","./SegmentedButtonItem","./SinglePlanningCalendarWeekView","./SinglePlanningCalendarGrid","./SinglePlanningCalendarRenderer","sap/base/Log","sap/ui/core/Control","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","sap/ui/core/date/UniversalDate","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateRange"],function(e,t,i,a,r,n,s,o,g,l,d,p,h,c,u,_,y){"use strict";var f=e.PlanningCalendarStickyMode;var w="_sHeaderResizeHandlerId";var m=o.extend("sap.m.SinglePlanningCalendar",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:""},startDate:{type:"object",group:"Data"},stickyMode:{type:"sap.m.PlanningCalendarStickyMode",group:"Behavior",defaultValue:f.None},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{actions:{type:"sap.ui.core.Control",multiple:true,singularName:"action",forwarding:{getter:"_getHeader",aggregation:"actions"}},appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",forwarding:{getter:"_getGrid",aggregation:"appointments"}},views:{type:"sap.m.SinglePlanningCalendarView",multiple:true,singularName:"view"},_header:{type:"sap.m.PlanningCalendarHeader",multiple:false,visibility:"hidden"},_grid:{type:"sap.m.SinglePlanningCalendarGrid",multiple:false,visibility:"hidden"}},associations:{selectedView:{type:"sap.m.SinglePlanningCalendarView",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},headerDateSelect:{parameters:{date:{type:"object"}}},startDateChange:{parameters:{date:{type:"object"}}}}}});m.prototype.init=function(){var e=this.getId();this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oDefaultView=new a({key:"DEFAULT_INNER_WEEK_VIEW_CREATED_FROM_CONTROL",title:""});this.setAssociation("selectedView",this._oDefaultView);this.setAggregation("_header",this._createHeader());this.setAggregation("_grid",new r(e+"-Grid"));this._attachHeaderEvents();this._attachGridEvents();this.setStartDate(new Date)};m.prototype.onBeforeRendering=function(){this._toggleStickyClasses()};m.prototype.onAfterRendering=function(){var e=this._getHeader();this._adjustColumnHeadersTopOffset();this.toggleStyleClass("sapMSinglePCActionsHidden",!e._getActionsToolbar().getVisible());this._registerResizeHandler(w,e,this._onHeaderResize.bind(this))};m.prototype.exit=function(){if(this._oDefaultView){this._oDefaultView.destroy();this._oDefaultView=null}this._deRegisterResizeHandler(w)};m.prototype._onHeaderResize=function(e){if(e.oldSize.height===e.size.height){return this}this.toggleStyleClass("sapMSinglePCActionsHidden",!this._getHeader()._getActionsToolbar().getVisible());this._adjustColumnHeadersTopOffset();return this};m.prototype.setTitle=function(e){this._getHeader().setTitle(e);return this.setProperty("title",e,true)};m.prototype.setStartDate=function(e){this.setProperty("startDate",e,true);this._alignColumns();return this};m.prototype.setEnableAppointmentsDragAndDrop=function(e){this._getGrid().setEnableAppointmentsDragAndDrop(e);return this.setProperty("enableAppointmentsDragAndDrop",e,true)};m.prototype._toggleStickyClasses=function(){var e=this.getStickyMode();this.toggleStyleClass("sapMSinglePCStickyAll",e===f.All);this.toggleStyleClass("sapMSinglePCStickyNavBarAndColHeaders",e===f.NavBarAndColHeaders);return this};m.prototype._adjustColumnHeadersTopOffset=function(){var e=this.getStickyMode(),t=this._getGrid(),i=t&&t._getColumnHeaders(),a;if(!i||!i.getDomRef()){return this}switch(e){case f.All:a=this._getHeader().$().outerHeight();break;case f.NavBarAndColHeaders:a=this._getHeader()._getNavigationToolbar().$().outerHeight();break;default:a="auto";break}i.$().css("top",a);return this};m.prototype.addView=function(e){var t;if(!e){return this}if(this._isViewKeyExisting(e.getKey())){s.error("There is an existing view with the same key.",this);return}this.addAggregation("views",e);t=this._getHeader()._getOrCreateViewSwitch();t.addItem(new i({key:e.getKey(),text:e.getTitle()}));if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",e)}this._alignView();return this};m.prototype.insertView=function(e,t){var a;if(!e){return this}if(this._isViewKeyExisting(e.getKey())){s.error("There is an existing view with the same key.",this);return}this.insertAggregation("views",e,t);a=this._getHeader()._getOrCreateViewSwitch();a.insertItem(new i({key:e.getKey(),text:e.getTitle()}),t);if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",e)}this._alignView();return this};m.prototype.removeView=function(e){if(!e){return this}var t=this._getHeader()._getOrCreateViewSwitch(),i=t.getItems(),a=this._getSelectedView(),r=e.getKey(),n,s;for(s=0;s<i.length;s++){n=i[s];if(n.getKey()===r){t.removeItem(n);break}}this.removeAggregation("views",e);if(r===a.getKey()){this.setAssociation("selectedView",this.getViews()[0]||this._oDefaultView)}this._alignView();return this};m.prototype.removeAllViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();e.removeAllItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.removeAllAggregation("views")};m.prototype.destroyViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();e.destroyItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.destroyAggregation("views")};m.prototype.getSelectedAppointments=function(){return this._getGrid().getSelectedAppointments()};m.prototype._alignView=function(){this._switchViewButtonVisibility();this._alignColumns();return this};m.prototype._createHeader=function(){var e=new t(this.getId()+"-Header");e.getAggregation("_actionsToolbar").addAriaLabelledBy(d.getStaticId("sap.m","SPC_ACTIONS_TOOLBAR"));e.getAggregation("_navigationToolbar").addAriaLabelledBy(d.getStaticId("sap.m","SPC_NAVIGATION_TOOLBAR"));return e};m.prototype._isViewKeyExisting=function(e){return this.getViews().some(function(t){return t.getKey()===e})};m.prototype._getSelectedView=function(){var e,t=this.getViews(),i=sap.ui.getCore().byId(this.getAssociation("selectedView")).getKey();for(var a=0;a<t.length;a++){if(i===t[a].getKey()){e=t[a];break}}return e||this._oDefaultView};m.prototype._switchViewButtonVisibility=function(){var e=this._getHeader()._getOrCreateViewSwitch(),t=e.getItems().length>1;e.setProperty("visible",t);return this};m.prototype._attachHeaderEvents=function(){var e=this._getHeader();e.attachEvent("pressPrevious",this._handlePressArrow,this);e.attachEvent("pressToday",this._handlePressToday,this);e.attachEvent("pressNext",this._handlePressArrow,this);e.attachEvent("dateSelect",this._handleCalendarPickerDateSelect,this);e._getOrCreateViewSwitch().attachEvent("selectionChange",this._handleViewSwitchChange,this);return this};m.prototype._attachGridEvents=function(){var e=this._getGrid();e._getColumnHeaders().attachEvent("select",function(e){this.fireHeaderDateSelect({date:e.getSource().getDate()})},this);e.attachEvent("appointmentSelect",function(e){this.fireAppointmentSelect({appointment:e.getParameter("appointment")})},this);e.attachEvent("appointmentDrop",function(e){this.fireAppointmentDrop({appointment:e.getParameter("appointment"),startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate"),copy:e.getParameter("copy")})},this);return this};m.prototype._handlePressArrow=function(e){this._applyArrowsLogic(e.getId()==="pressPrevious")};m.prototype._handlePressToday=function(){var e=this._getSelectedView().calculateStartDate(new Date);this.setStartDate(e);this.fireStartDateChange({date:e})};m.prototype._handleViewSwitchChange=function(e){this.setAssociation("selectedView",e.getParameter("item"));this._alignColumns()};m.prototype._handleCalendarPickerDateSelect=function(){var e=this._getHeader().getStartDate();e=this._getSelectedView().calculateStartDate(new Date(e.getTime()));this.setStartDate(e);this.fireStartDateChange({date:e})};m.prototype._updateCalendarPickerSelection=function(){var e=this._getFirstAndLastRangeDate(),t;t=new y({startDate:e.oStartDate.toLocalJSDate(),endDate:e.oEndDate.toLocalJSDate()});this._getHeader().getAggregation("_calendarPicker").removeAllSelectedDates();this._getHeader().getAggregation("_calendarPicker").addSelectedDate(t)};m.prototype._formatPickerText=function(){var e=this._getFirstAndLastRangeDate(),t=e.oStartDate.toLocalJSDate(),i=e.oEndDate.toLocalJSDate(),a=c.getDateInstance({style:"long"}),r=a.format(t);if(t.getTime()!==i.getTime()){r+=" - "+a.format(i)}return r};m.prototype._applyArrowsLogic=function(e){var t=u.fromLocalJSDate(this.getStartDate()||new Date),i=this._getSelectedView().getScrollEntityCount(),a;if(e){i*=-1}t.setDate(t.getDate()+i);a=t.toLocalJSDate();this.setStartDate(a);this.fireStartDateChange({date:a})};m.prototype._getFirstAndLastRangeDate=function(){var e=this._getSelectedView(),t=this._getHeader().getStartDate()||new Date,i=e.getEntityCount()-1,a,r;a=u.fromLocalJSDate(e.calculateStartDate(new Date(t.getTime())));r=new u(a);r.setDate(a.getDate()+i);return{oStartDate:a,oEndDate:r}};m.prototype._alignColumns=function(){var e=this._getHeader(),t=this._getGrid(),i=this._getSelectedView(),a=this.getStartDate()||new Date,r=i.calculateStartDate(new Date(a.getTime())),n=u.fromLocalJSDate(r);e.setStartDate(r);e.setPickerText(this._formatPickerText(n));this._updateCalendarPickerSelection();t.setStartDate(r);t._setColumns(i.getEntityCount());this._setColumnHeaderVisibility()};m.prototype._setColumnHeaderVisibility=function(){var e=!this._getSelectedView().isA("sap.m.SinglePlanningCalendarDayView");this._getGrid()._getColumnHeaders().setVisible(e)};m.prototype._getHeader=function(){return this.getAggregation("_header")};m.prototype._getGrid=function(){return this.getAggregation("_grid")};m.prototype._registerResizeHandler=function(e,t,i){if(!this[e]){this[e]=p.register(t,i)}return this};m.prototype._deRegisterResizeHandler=function(e){if(this[e]){p.deregister(this[e]);this[e]=null}return this};return m});