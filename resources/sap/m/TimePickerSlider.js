/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./TimePickerSliderRenderer","sap/ui/core/IconPool","sap/ui/Device","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery"],function(e,t,i,s,n,a){"use strict";var o=e.extend("sap.m.TimePickerSlider",{metadata:{library:"sap.m",properties:{selectedValue:{type:"string",defaultValue:null},isCyclic:{type:"boolean",defaultValue:true},label:{type:"string",defaultValue:null},isExpanded:{type:"boolean",defaultValue:false}},aggregations:{items:{type:"sap.m.VisibleItem",multiple:true,singularName:"item"},_arrowUp:{type:"sap.m.Button",multiple:false,visibility:"hidden"},_arrowDown:{type:"sap.m.Button",multiple:false,visibility:"hidden"}},events:{expanded:{},collapsed:{}}},renderer:t.render});var r=sap.ui.getCore().getConfiguration().getAnimation()?200:0;var l=50;var h=32;var d=32;o.prototype.init=function(){this._bIsDrag=null;this._selectionOffset=0;this._mousedown=false;this._dragSession=null;this._iSelectedItemIndex=-1;this._animatingSnap=false;this._iSelectedIndex=-1;this._animating=false;this._intervalId=null;this._maxScrollTop=null;this._minScrollTop=null;this._marginTop=null;this._marginBottom=null;this._bOneTimeValueSelectionAnimation=false;this._bEnabled=true;if(s.system.desktop){this._fnHandleTypeValues=m.call(this)}this._initArrows()};o.prototype.exit=function(){var e=this._getSliderContainerDomRef();if(e){e.stop()}if(this._intervalId){clearInterval(this._intervalId);this._intervalId=null}};o.prototype.onAfterRendering=function(){if(s.system.phone){setTimeout(this._afterExpandCollapse.bind(this),0)}else{this._afterExpandCollapse()}this._attachEvents()};o.prototype.onThemeChanged=function(e){this.invalidate()};o.prototype.fireTap=function(e){var t,i,n;if(!this.getIsExpanded()){if(s.system.desktop){this.focus()}else{this.setIsExpanded(true)}}else{t=e.srcElement||e.originalTarget;if(t&&t.tagName.toLowerCase()==="li"){i=a(t).text();n=g.call(this,i);this._bOneTimeValueSelectionAnimation=true;this.setSelectedValue(n);this._fireSelectedValueChange(n)}else{this._addSelectionStyle();this.focus()}}};o.prototype.setSelectedValue=function(e){var t=p(this._getVisibleItems(),function(t){return t.getKey()===e}),i=this,s,n,a,o;if(t===-1){return this}if(this.getDomRef()){n=this._getSliderContainerDomRef();a=this._getItemHeightInPx();o=this._getContentRepeat();if(t*a>=this._selectionOffset){s=this._getVisibleItems().length*Math.floor(o/2)+t}else{s=this._getVisibleItems().length*Math.ceil(o/2)+t}if(this._bOneTimeValueSelectionAnimation){this._animatingSnap=true;n.animate({scrollTop:s*a-this._selectionOffset},r,"linear",function(){n.clearQueue();i._animatingSnap=false;i._bOneTimeValueSelectionAnimation=false})}else{n.scrollTop(s*a-this._selectionOffset)}this._removeSelectionStyle();this._iSelectedItemIndex=s;this._addSelectionStyle()}return this.setProperty("selectedValue",e,true)};o.prototype.setIsExpanded=function(e,t){this.setProperty("isExpanded",e,true);if(!this.getDomRef()){return this}var i=this.$();if(e){i.addClass("sapMTPSliderExpanded");if(s.system.phone){setTimeout(function(){this._updateDynamicLayout(e);if(!t){this.fireExpanded({ctrl:this})}}.bind(this),0)}else{this._updateDynamicLayout(e);if(!t){this.fireExpanded({ctrl:this})}}}else{this._stopAnimation();if(this._animatingSnap===true){this._animatingSnap=false;this._getSliderContainerDomRef().stop(true);if(this._animatingTargetIndex!==null){this._scrollerSnapped(this._animatingTargetIndex);this._animatingTargetIndex=null}else if(this._iSelectedIndex!==-1){this._scrollerSnapped(this._iSelectedIndex)}}i.removeClass("sapMTPSliderExpanded");this._updateMargins(e);if(s.system.phone){setTimeout(this._afterExpandCollapse.bind(this),0)}else{this._afterExpandCollapse()}if(!t){this.fireCollapsed({ctrl:this})}}return this};o.prototype.setIsCyclic=function(e){if(this.getDomRef()){if(e){this.$().removeClass("sapMTimePickerSliderShort")}else{this.$().addClass("sapMTimePickerSliderShort")}}return this.setProperty("isCyclic",e,false)};o.prototype.onfocusin=function(e){if(s.system.desktop&&!this.getIsExpanded()){this.setIsExpanded(true)}};o.prototype.onfocusout=function(e){var t=e.relatedTarget?e.relatedTarget.id:null,i=[this.getAggregation("_arrowUp").getId(),this.getAggregation("_arrowDown").getId()];if(t&&i.indexOf(t)!==-1){return}if(s.system.desktop&&this.getIsExpanded()){this.setIsExpanded(false)}};o.prototype._onmousewheel=function(e){e.preventDefault();e.stopPropagation();if(!this.getIsExpanded()){return false}var t=e.originalEvent,i=t.detail?-t.detail>0:t.wheelDelta>0,s=i?Math.ceil:Math.floor,n=t.detail?-t.detail/3:t.wheelDelta/120,a=this,o;if(!n){return false}if(!this._aWheelDeltas){this._aWheelDeltas=[]}a._aWheelDeltas.push(n);if(!this._bWheelScrolling){this._bWheelScrolling=true;this._intervalId=setInterval(function(){if(!a._aWheelDeltas.length){clearInterval(a._intervalId);a._intervalId=null;a._bWheelScrolling=false}else{o=a._aWheelDeltas[0];a._aWheelDeltas=[];o=s(o);if(o){a._offsetSlider(o)}}},150)}return false};o.prototype.onsappageup=function(e){if(this.getIsExpanded()){var t=this._getVisibleItems()[0],i=t.getKey();this.setSelectedValue(i);this._fireSelectedValueChange(i)}};o.prototype.onsappagedown=function(e){if(this.getIsExpanded()){var t=this._getVisibleItems()[this._getVisibleItems().length-1],i=t.getKey();this.setSelectedValue(i);this._fireSelectedValueChange(i)}};o.prototype.onsapup=function(e){if(this.getIsExpanded()){this._offsetValue(-1)}};o.prototype.onsapdown=function(e){if(this.getIsExpanded()){this._offsetValue(1)}};o.prototype.onkeydown=function(e){var t=e.which||e.keyCode,i=n;if(t>=i.NUMPAD_0&&t<=i.NUMPAD_9){t=this._convertNumPadToNumKeyCode(t)}if(t>=i.A&&t<=i.Z||t>=i.DIGIT_0&&t<=i.DIGIT_9){this._fnHandleTypeValues(e.timeStamp,t)}};o.prototype._getSliderContainerDomRef=function(){return this.$().find(".sapMTimePickerSlider")};o.prototype._getContentRepeat=function(){var e;if(this.getIsCyclic()){e=Math.ceil(l/this._getVisibleItems().length);e=Math.max(e,3)}else{e=1}return e};o.prototype._getItemHeightInPx=function(){return this.$("content").find("li:not(.TPSliderItemHidden)")[0].getBoundingClientRect().height};o.prototype._updateSelectionFrameLayout=function(){var e,t,i,n,a=this.$().offset(),o=a?a.top:0,r=this.$().parents(".sapMTimePickerContainer").offset(),l=r?r.top:0;if(this.getDomRef()){n=this._getItemHeightInPx();e=this.$().find(".sapMTPPickerSelectionFrame");i=o-l;t=(this.$().height()-n+h)/2+i;e.css("top",t);if(s.system.phone){setTimeout(this._afterExpandCollapse.bind(this),0)}else{this._afterExpandCollapse()}}};o.prototype._updateStepAndValue=function(e,t){var i=0,s,n;for(n=0;n<this.getItems().length;n++){if(n%t!==0&&n!==e){this.getItems()[n].setVisible(false)}else{this.getItems()[n].setVisible(true);i++}}if(i>2&&i<13&&this.getDomRef()){s=this.$().find(".sapMTimePickerSlider");s.className="";a(s).addClass("sapMTimePickerSlider SliderValues"+i.toString())}this.setIsCyclic(i>2);this.setSelectedValue(e.toString())};o.prototype._updateMargins=function(e){var t=this._getItemHeightInPx(),i,s,n,a,o,r,l,p;if(this.getDomRef()){t=this._getItemHeightInPx();i=this.$().find(".SliderValues3,.SliderValues4,.SliderValues5,.SliderValues6,.SliderValues7,.SliderValues8,.SliderValues9,.SliderValues10,.SliderValues11,.SliderValues12");if(!i.length){return}if(e){s=this._getVisibleItems().length;n=t*Math.floor(s/2);a=t*Math.ceil(s/2);r=this.$().parents().hasClass("sapUiSizeCompact")?d:0;o=(this.$().height()-t+h)/2;l=o-n-h-r;p=this.$().height()-o-a-r;l=Math.max(l,0);p=Math.max(p,0)}else{l=0;p=0}i.css("margin-top",l);i.css("margin-bottom",p)}};o.prototype._updateDynamicLayout=function(e){this._updateMargins(e);this._updateSelectionFrameLayout()};o.prototype._getSelectionFrameTopOffset=function(){var e=this._getSliderContainerDomRef().find(".sapMTPPickerSelectionFrame"),t=e.offset();return t.top};o.prototype._animateScroll=function(e){var t=this._getSliderContainerDomRef(),i=t.scrollTop(),s=25,n=t.height(),a=this.$("content").height(),o=200,l=n+o,h=this._getContentRepeat(),d=this.getIsCyclic(),p=.9,f=.05,u=this;this._intervalId=setInterval(function(){u._animating=true;i=i-e*s;if(d){i=u._getUpdatedCycleScrollTop(n,a,i,l,h)}else{if(i>u._maxScrollTop){i=u._maxScrollTop;e=0}if(i<u._minScrollTop){i=u._minScrollTop;e=0}}t.scrollTop(i);e*=p;if(Math.abs(e)<f){var o=u._getItemHeightInPx();var c=u._selectionOffset?u._selectionOffset%o:0;var g=Math.round((i+c)/o)*o-c;clearInterval(u._intervalId);u._intervalId=null;u._animating=null;u._iSelectedIndex=Math.round((i+u._selectionOffset)/o);u._animatingSnap=true;t.animate({scrollTop:g},r,"linear",function(){t.clearQueue();u._animatingSnap=false;if(t.css("visibility")==="visible"){u._scrollerSnapped(u._iSelectedIndex)}})}},s)};o.prototype._stopAnimation=function(){if(this._animating){clearInterval(this._intervalId);this._intervalId=null;this._animating=null}};o.prototype._startDrag=function(e){if(!this._dragSession){this._dragSession={};this._dragSession.positions=[]}this._dragSession.pageY=e;this._dragSession.startTop=this._getSliderContainerDomRef().scrollTop()};o.prototype._doDrag=function(e,t){if(this._dragSession){this._dragSession.offsetY=e-this._dragSession.pageY;this._dragSession.positions.push({pageY:e,timeStamp:t});if(this._dragSession.positions.length>20){this._dragSession.positions.splice(0,10)}if(this._bIsDrag){this._getSliderContainerDomRef().scrollTop(this._dragSession.startTop-this._dragSession.offsetY)}}};o.prototype._endDrag=function(e,t){if(this._dragSession){var i,s;for(var n=this._dragSession.positions.length-1;n>=0;n--){i=t-this._dragSession.positions[n].timeStamp;s=e-this._dragSession.positions[n].pageY;if(i>100){break}}var a=s/i;if(this._animating){clearInterval(this._intervalId);this._intervalId=null;this._animating=null}this._dragSession=null;this._animateScroll(a)}};o.prototype._afterExpandCollapse=function(){var e=this.getSelectedValue(),t=this._getSelectionFrameTopOffset(),i=this._getSliderContainerDomRef(),s=i.offset(),n,a,o,r;this._selectionOffset=t-s.top;if(!this.getIsCyclic()){a=this.$("content");r=this._getItemHeightInPx();o=this.$().height();if(this.getIsExpanded()){this._minScrollTop=0;this._marginTop=t-s.top;this._maxScrollTop=r*(this._getVisibleItems().length-1);n=i.height();this._marginBottom=n-this._marginTop-r;if(this._marginBottom<0){this._marginBottom=o-this._marginTop-r}a.css("margin-top",this._marginTop);a.css("margin-bottom",this._marginBottom)}else{this._marginBottom=o-r;a.css("margin-top",0);a.css("margin-bottom",this._marginBottom)}this._selectionOffset=0}if(!this.getIsExpanded()){this._selectionOffset=0}this.$().attr("aria-expanded",this.getIsExpanded());this.setSelectedValue(e)};o.prototype._getUpdatedCycleScrollTop=function(e,t,i,s,n){var a=t-i-e;while(a<s){i=i-t/n;a=t-i-e}while(i<s){i=i+t/n}return i};o.prototype._scrollerSnapped=function(e){var t=e,i=this._getVisibleItems().length,s;while(t>=i){t=t-i}if(!this.getIsCyclic()){t=e}s=this._getVisibleItems()[t].getKey();this.setSelectedValue(s);this._fireSelectedValueChange(s)};o.prototype._updateScroll=function(){var e=this.getSelectedValue();if(e!==this._getVisibleItems()[0].getKey()&&this._getSliderContainerDomRef().scrollTop()+(this._selectionOffset?this._selectionOffset:0)===0){this.setSelectedValue(e);this._fireSelectedValueChange(e)}};o.prototype._addSelectionStyle=function(){var e=this.$("content").find("li:not(.TPSliderItemHidden)"),t=e.eq(this._iSelectedItemIndex).text(),i,s;if(!t){return}s=t;if(s&&s.length>1&&s.indexOf("0")===0){s=s.substring(1)}e.eq(this._iSelectedItemIndex).addClass("sapMTimePickerItemSelected");i=document.getElementById(this.getId()+"-valDescription");if(i.innerHTML!==s){i.innerHTML=s}};o.prototype._removeSelectionStyle=function(){var e=this.$("content").find("li:not(.TPSliderItemHidden)");e.eq(this._iSelectedItemIndex).removeClass("sapMTimePickerItemSelected").attr("aria-selected","false")};o.prototype._attachEvents=function(){var e=this._getSliderContainerDomRef()[0];if(s.system.combi){e.addEventListener("touchstart",a.proxy(f,this),false);e.addEventListener("touchmove",a.proxy(u,this),false);document.addEventListener("touchend",a.proxy(c,this),false);e.addEventListener("mousedown",a.proxy(f,this),false);document.addEventListener("mousemove",a.proxy(u,this),false);document.addEventListener("mouseup",a.proxy(c,this),false)}else{if(s.system.phone||s.system.tablet){e.addEventListener("touchstart",a.proxy(f,this),false);e.addEventListener("touchmove",a.proxy(u,this),false);document.addEventListener("touchend",a.proxy(c,this),false)}else{e.addEventListener("mousedown",a.proxy(f,this),false);document.addEventListener("mousemove",a.proxy(u,this),false);document.addEventListener("mouseup",a.proxy(c,this),false)}}};o.prototype._detachEvents=function(){var e=this.getDomRef();if(s.system.combi){e.removeEventListener("touchstart",a.proxy(f,this),false);e.removeEventListener("touchmove",a.proxy(u,this),false);document.removeEventListener("touchend",a.proxy(c,this),false);e.removeEventListener("mousedown",a.proxy(f,this),false);document.removeEventListener("mousemove",a.proxy(u,this),false);document.removeEventListener("mouseup",a.proxy(c,this),false)}else{if(s.system.phone||s.system.tablet){e.removeEventListener("touchstart",a.proxy(f,this),false);e.removeEventListener("touchmove",a.proxy(u,this),false);document.removeEventListener("touchend",a.proxy(c,this),false)}else{e.removeEventListener("mousedown",a.proxy(f,this),false);document.removeEventListener("mousemove",a.proxy(u,this),false);document.removeEventListener("mouseup",a.proxy(c,this),false)}}};o.prototype._offsetValue=function(e){var t=this._getSliderContainerDomRef(),i,s=this._getItemHeightInPx(),n,a,o=this.getIsCyclic(),l=this;this._stopAnimation();if(this._animatingSnap===true){this._animatingSnap=false;this._getSliderContainerDomRef().stop(true);if(this._animatingTargetIndex!==null){this._scrollerSnapped(this._animatingTargetIndex);this._animatingTargetIndex=null}else if(this._iSelectedIndex!==-1){this._scrollerSnapped(this._iSelectedIndex)}}a=this._iSelectedItemIndex+e;i=t.scrollTop();n=i+e*s;if(!o){if(a<0||a>=this._getVisibleItems().length){return}if(n>this._maxScrollTop){n=this._maxScrollTop}if(n<this._minScrollTop){n=this._minScrollTop}}this._animatingSnap=true;this._animatingTargetIndex=a;t.animate({scrollTop:n},r,"linear",function(){t.clearQueue();l._animatingSnap=false;l._animatingTargetIndex=null;if(t.css("visibility")==="visible"){l._scrollerSnapped(a)}})};o.prototype._offsetSlider=function(e){var t=this._getSliderContainerDomRef().scrollTop(),i=this,s=i._getSliderContainerDomRef().height(),n=i.$("content").height(),a=200,o=s+a,r=i._getContentRepeat(),l=i.getIsCyclic(),h=i._getItemHeightInPx();t=t-e*h;if(l){t=i._getUpdatedCycleScrollTop(s,n,t,o,r)}else{if(t>i._maxScrollTop){t=i._maxScrollTop}if(t<i._minScrollTop){t=i._minScrollTop}}i._getSliderContainerDomRef().scrollTop(t);i._iSelectedIndex=Math.round((t+i._selectionOffset)/h);i._scrollerSnapped(i._iSelectedIndex)};o.prototype._initArrows=function(){var e=this,t,s;t=new sap.m.Button({icon:i.getIconURI("slim-arrow-up"),press:function(t){e._offsetValue(-1)},type:"Transparent"});t.addEventDelegate({onAfterRendering:function(){t.$().attr("tabindex",-1)}});this.setAggregation("_arrowUp",t);s=new sap.m.Button({icon:i.getIconURI("slim-arrow-down"),press:function(t){e._offsetValue(1)},type:"Transparent"});s.addStyleClass("sapMTimePickerItemArrowDown");s.addEventDelegate({onAfterRendering:function(){s.$().attr("tabindex",-1)}});this.setAggregation("_arrowDown",s)};o.prototype._convertNumPadToNumKeyCode=function(e){var t=n;if(e>=t.NUMPAD_0&&e<=t.NUMPAD_9){e-=48}return e};function p(e,t){if(e==null){throw new TypeError("findIndex called with null or undefined array")}if(typeof t!=="function"){throw new TypeError("predicate must be a function")}var i=e.length;var s=arguments[1];var n;for(var a=0;a<i;a++){n=e[a];if(t.call(s,n,a,e)){return a}}return-1}var f=function(e){var t=e.touches&&e.touches.length?e.touches[0].pageY:e.pageY;this._bIsDrag=false;if(!this.getIsExpanded()){return}this._stopAnimation();this._startDrag(t);e.preventDefault();this._mousedown=true};var u=function(e){var t=e.touches&&e.touches.length?e.touches[0].pageY:e.pageY;if(!this._mousedown||!this.getIsExpanded()){return}if(!this._bIsDrag&&this._dragSession&&this._dragSession.positions.length){var i=this._dragSession.positions.some(function(e){return Math.abs(e.pageY-t)>5});if(i){this._bIsDrag=true}}this._doDrag(t,e.timeStamp);this._mousedown=true};var c=function(e){var t=e.changedTouches&&e.changedTouches.length?e.changedTouches[0].pageY:e.pageY;if(this._bIsDrag===false){this.fireTap(e);this._dragSession=null}this._bIsDrag=true;if(!this.getIsExpanded()){this._dragSession=null;return}this._endDrag(t,e.timeStamp);this._mousedown=false};var g=function(e){var t=this._getVisibleItems();var i=p(t,function(t){return t.getText()===e});return t[i].getKey()};var m=function(){var e=-1,t=-1,i=1e3,s="",n=function(n,a){var o;if(e+i<n){s=""}else{if(t!==-1){clearTimeout(t);t=-1}}s+=String.fromCharCode(a).toLowerCase();o=this._getVisibleItems().filter(function(e){return e.getKey().indexOf(s)===0});if(o.length>1){t=setTimeout(function(){this.setSelectedValue(s);s="";t=-1}.bind(this),i)}else if(o.length===1){this.setSelectedValue(o[0].getKey());s=""}else{s=""}e=n};return n};o.prototype._getVisibleItems=function(){return this.getItems().filter(function(e){return e.getVisible()})};o.prototype._setEnabled=function(e){this._bEnabled=e;if(e){this.$().removeClass("sapMTPDisabled");this.$().attr("tabindex",0)}else{this.$().addClass("sapMTPDisabled");this.$().attr("tabindex",-1)}return this};o.prototype._getEnabled=function(e){return this._bEnabled};o.prototype._fireSelectedValueChange=function(e){this.fireEvent("_selectedValueChange",{value:e})};return o});