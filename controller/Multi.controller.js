sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter"],function(t,e,i){"use strict";return t.extend("flush.game.controller.Multi",{formatter:i,onInit:function(){t.prototype.onInit.apply(this,arguments);var i=new e({player1wins:0,player2wins:0,instructions:""});this.setModel(i,"view");this.getRouter().getRoute("multi").attachPatternMatched(this._onNavigation,this);this.getRouter().getTarget("multi").attachDisplay(this._onNavigation,this);this.getRouter().attachRouteMatched(function(t){var e=t.getParameter("name");if(e!=="multi"){clearTimeout(this._iIdleTimer);clearInterval(this._iFocusInterval)}}.bind(this))},_onNavigation:function(){this._controlWeather(arguments[0]);this._updateGame(arguments[0]);this._unlockLevels(arguments[0]);this._manageIdle(arguments[0]);this._ensureFocus(arguments[0])},_controlWeather:function(){this.ready().then(function(){if(!this.getSoundManager().isPlaying("thunderLightning")){this.getSoundManager().play("thunderLightning")}this.getBadWeather().rain("moderate");this.getBadWeather().lightning()}.bind(this))},_updateGame:function(t){var e;var i;var a;if(t&&t.getParameter("data")){e=t.getParameter("data").who;i=t.getParameter("data").level;a=parseInt(t.getParameter("data").difficulty)}this.getModel("appView").setProperty("/mode","2player");this.ready().then(function(){var t=function(){this._playStory("randomQuotes")}.bind(this);if(!e&&this.getModel("appView").getProperty("/multiProgress")===1){this._reset()}if(e){this._markLastLevelAsWon(e,i,a);this.getModel("appView").setProperty("/multiProgress",this.getModel("appView").getProperty("/multiProgress")+1);this._playStory("player"+e+"win").then(t);this.getModel("view").setProperty("/player"+e+"wins",this.getModel("view").getProperty("/player"+e+"wins")+1);this._bMatchWon=true;this.getSoundManager().play("Win").then(function(){this.getSoundManager().play("roboWin");this._bMatchWon=false}.bind(this));clearTimeout(this._iLockTimer);this._bLockedAfterLevel=true;this._iLockTimer=setTimeout(function(){this._bLockedAfterLevel=false}.bind(this),3e3)}else{if(!this._bMatchWon){this._playStory("intro").then(t)}}}.bind(this))},_unlockLevels:function(){this.ready().then(function(){var t=this.getModel("appView"),e=t.getProperty("/multiProgress");if(t.getProperty("/godMode")){e=99999999}var i=this.byId("levels").getTiles();for(var a=0;a<i.length;a++){(function(t){setTimeout(function(){var a=t>=e;i[t].setLocked(a);if(!a){i[t].focus()}}.bind(this),500+t*200)})(a)}}.bind(this))},_markLastLevelAsWon:function(t,e,i){var a=this.getModel("appView");var r=this.byId("levels").getTiles();r.some(function(a){if(e===a.getCustomData()[0].getValue()&&i===parseInt(a.getCustomData()[1].getValue())){a.removeStyleClass("player"+(t===1?2:1)+"win");a.addStyleClass("player"+t+"win");return true}})},_reset:function(){this.getModel("view").setProperty("/player1wins",0);this.getModel("view").setProperty("/player2wins",0);var t=this.byId("levels").getTiles();for(var e=0;e<t.length;e++){t[e].removeStyleClass("player1win");t[e].removeStyleClass("player2win")}},_manageIdle:function(){clearTimeout(this._iIdleTimer);this._iIdleTimer=setTimeout(function(){this.onIntro()}.bind(this),this.getModel("appView").getProperty("/idleTimeReloopIntro"))},_ensureFocus:function(){clearInterval(this._iFocusInterval);var t=function(){var t=sap.ui.getCore().byId(document.activeElement.getAttribute("id"));if(!t||t.getMetadata().getName().split(".").pop()!=="GameTile"){this.byId("levels").getTiles()[0].focus()}}.bind(this);t();this._iFocusInterval=setInterval(t,2500)},onIntro:function(){this._stopStory();this.getRouter().navTo("intro")},onLevel:function(t){if(this._bLockedAfterLevel){return}this.getSoundManager().play("start");this.getBadWeather().stop();var e=t.getSource();var i=e.getCustomData()[0].getValue(),a=parseInt(e.getCustomData()[1].getValue());this._stopStory();this.getRouter().navTo("game",{level:i,difficulty:a})}})});