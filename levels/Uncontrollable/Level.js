sap.ui.define(["sap/ui/base/Object"],function(e){"use strict";var t,i,a,s,n,r,o;var h,l;var d=false;var c=30;var y=100;var p=20;var u;var m;var _;var v;var g;var f;var b;var w=[];var x;var k;var D=3;var T=true;var A={PLAYER:1,PLAYERBOTTOM:2,RENDERMANAGER:3,CONTROL:4};var B={POLYGON:1,CIRCLE:2};var C;var L=[];var S=Box2D.Common.Math.b2Vec2;var O=Box2D.Dynamics.b2BodyDef;var G=Box2D.Dynamics.b2Body;var P=Box2D.Dynamics.b2FixtureDef;var j=Box2D.Dynamics.b2World;var R=Box2D.Collision.Shapes.b2PolygonShape;var E=Box2D.Collision.Shapes.b2CircleShape;var F=Box2D.Dynamics.b2DebugDraw;var M=Box2D.Dynamics.b2ContactListener;var I={spawnGameObject:function(e,i,a){var n;if(e.spriteSheet){n=new createjs.Sprite(e.spriteSheet,e.spriteSheetAnimation);n.spriteSheetAnimation=e.spriteSheetAnimation}else if(e.assetId){n=new createjs.Bitmap(s.getResult(e.assetId))}else if(e.control){n=new createjs.Bitmap;n.image=e.control._image}if(e.width)n.width=e.width;if(e.height)n.height=e.height;if(e.x)n.x=e.x;if(e.y)n.y=e.y;if(e.regX){n.regX=e.regX}else{n.regX=parseInt(e.width/2)}if(e.regY){n.regY=e.regY}else{n.regY=parseInt(e.height/2)}if(e.scaleX)n.scaleX=e.scaleX;if(e.scaleY)n.scaleY=e.scaleY;if(e.control)n.control=e.control;if(e.assetId)n.assetId=e.assetId;if(e.snapToPixel)n.snapToPixel=e.snapToPixel;if(e.mouseEnabled)n.mouseEnabled=e.mouseEnabled;if(e.gameObjectType)n.gameObjectType=e.gameObjectType;if(e.shapeType)n.shapeType=e.shapeType;if(e.density)n.density=e.density;if(e.isStaticBody)n.isStaticBody=e.isStaticBody;if(e.gameObjectType==A.PLAYER){a=n;h=a}t.addChild(n);if(e.hasBox2dBody===true){return Y.createGameObjectBodyAndActor(n,i)}return n}};var Y=function(){var e=1,s=20,n=1/s;var r=Date.now();var u=0;var g=[];var f=[];var D=[];var T=true;var I=function(){C=new j(new S(0,6),true);var t=new F;t.SetSprite(o);t.SetDrawScale(c);t.SetFillAlpha(.7);t.SetLineThickness(1);t.SetFlags(F.e_shapeBit|F.e_jointBit);C.SetDebugDraw(t);var s=function(e){var t=e[0],i=e[1];if(Math.abs(l.GetLinearVelocity().y)<6&&l.GetPosition().y>6){l.ApplyForce(new S(0,i*y*5),l.GetPosition());x=Date.now();w.push(l.GetPosition().x);if(w.length>3){var a=0;for(var s=0;s<w.length-2;s++){a+=w[s+1]-w[s]}if(Math.abs(a)>2){k=Date.now();d=false}}if(w.length>10){w.shift()}}l.ApplyForce(new S(t*y,t*y),l.GetPosition());l.SetLinearDamping(.5);l.SetFixedRotation(true)};this.fnKeyDown=function(e){switch(e.key){case"ArrowLeft":case"a":this._movement[0]=-1;break;case"ArrowRight":case"d":this._movement[0]=1;break;case"ArrowUp":case"w":if(!m.getSoundManager().isPlaying("Raketenduese")){m.getSoundManager().play("Raketenduese",undefined,undefined,.5)}h.gotoAndPlay("fly");this._movement[1]=-1;break;case"ArrowDown":case"s":this._movement[0]=1;break;case" ":break;case"Enter":break}if(this._movement[0]||this._movement[1]){clearInterval(this._iIntervalMove);this._iIntervalMove=setInterval(function(){s(this._movement)}.bind(this),p)}}.bind(this);this.fnKeyUp=function(e){switch(e.key){case"ArrowLeft":case"a":this._movement[0]=0;clearInterval(this._iIntervalLeft);break;case"ArrowRight":case"d":this._movement[0]=0;clearInterval(this._iIntervalRight);break;case"ArrowUp":case"w":m.getSoundManager().stop("Raketenduese");h.gotoAndPlay("run");this._movement[1]=0;clearInterval(this._iIntervalUp);break;case"ArrowDown":case"s":this._movement[0]=0;clearInterval(this._iIntervalDown);break;case" ":break;case"Enter":break}}.bind(this);this._movement=[0,0];document.addEventListener("keydown",this.fnKeyDown);document.addEventListener("keyup",this.fnKeyUp);var n=new M;n.BeginContact=function(e){if(e.GetFixtureA().m_body.m_userData&&e.GetFixtureB().m_body.m_userData&&e.GetFixtureA().m_body.m_userData.skin&&e.GetFixtureB().m_body.m_userData.skin&&(e.GetFixtureA().m_body.m_userData.skin.gameObjectType===A.PLAYER&&!e.GetFixtureA().m_userData&&e.GetFixtureB().m_body.m_userData.skin.gameObjectType===A.CONTROL||e.GetFixtureB().m_body.m_userData.skin.gameObjectType===A.PLAYER&&!e.GetFixtureB().m_userData&&e.GetFixtureA().m_body.m_userData.skin.gameObjectType===A.CONTROL)){if(T){T=false;v=setTimeout(function(){T=true},500);m.score(-100*_/10,[l.GetPosition().x*c+25,l.GetPosition().y*c+25]);m.triggerEvent("Haha");b=Date.now()}}};C.SetContactListener(n);var r=new P;r.density=.3;r.restitution=.5;r.shape=new R;r.shape.SetAsBox(i/c,e/c);var u=new O;u.type=G.b2_staticBody;u.position.x=0;u.position.y=a/c;var g=C.CreateBody(u);g.CreateFixture(r);var f=new P;f.shape=new R;f.shape.SetAsBox(e/c,a/c);var D=new O;D.type=G.b2_staticBody;D.position.x=0;D.position.y=a/c;var B=C.CreateBody(D);B.CreateFixture(f)};var Y=function(e,t){this.body=e;this.skin=t;this.update=function(){this.skin.rotation=this.body.GetAngle()*(180/Math.PI);this.skin.x=this.body.GetWorldCenter().x*c;this.skin.y=this.body.GetWorldCenter().y*c};L.push(this)};var U=function(e,t){var i=new P;i.density=e.density;i.restitution=.1;var a=new O;if(e.shapeType==B.POLYGON){i.shape=new R;if(e.gameObjectType==A.PLAYER){i.shape.SetAsBox(e.width/c/2,(e.height-30)/c/2)}else{i.shape.SetAsBox(e.width/c/2,e.height/c/2)}a.position.x=(e.x+e.width/2)/c;a.position.y=(e.y+e.height/2)/c}if(e.shapeType==B.CIRCLE){i.shape=new E(e.width/2/c);a.position.x=e.x/c;a.position.y=e.y/c}if(e.isStaticBody===true){a.type=G.b2_staticBody}else{a.type=G.b2_dynamicBody}var s=C.CreateBody(a);s.skin=e;if(e.gameObjectType==A.PLAYER){t=s;l=t}if(e.gameObjectType==A.PLAYER){var n=new P;n.density=e.density;n.restitution=.1;n.shape=new R;n.shape.SetAsOrientedBox(e.width/c/2,1/c/2,new S(0,e.height/2/c));n.userData=true;s.CreateFixture(n)}var r=s.CreateFixture(i);r.skin=e;if(e.gameObjectType==A.CONTROL){var o=2*_/10;var h=Math.random()*o+1.5;s.ApplyImpulse(new S(-4*s.m_mass*h,-4.3*s.m_mass*h*.6),s.GetPosition())}var d=new Y(s,e);s.SetUserData(d);if(e.gameObjectType==A.CONTROL||e.assetId==="ALVTable"){f.push(s)}else{D.push(s)}return s};var V=function(e){if(e){t.removeChild(e.skin);L.splice(L.indexOf(e),1)}};var X=function(){var e=Date.now();var t=e-r;u+=t;r=e;while(u>=s){for(var i=0,a=g.length;i<a;i++){V(g[i].GetUserData());g[i].SetUserData(null);C.DestroyBody(g[i])}g=[];for(var i=0,a=L.length;i<a;i++){L[i].update()}C.Step(n,10,10);u-=s;C.ClearForces();C.m_debugDraw.m_sprite.graphics.clear();C.DrawDebugData();if(f.length>30){g.push(f[0]);f.splice(0,1)}}};var N=function(e){if(e){n=0}else{n=1/s}r=Date.now()};return{setup:I,update:X,createGameObjectBodyAndActor:U,pauseResume:N}}();return e.extend("flush.levels.demo",{constructor:function(e,t,i){m=e;this._oCanvas=t[0];this._oDebugCanvas=t[0];this._oControlManager=i},tick:function(e){if(Math.random()<.1){w.shift()}if(T){var s=e.delta/1e3;this._skyline1.x=this._skyline1.x-s*30;if(this._skyline1.x+this._skyline1.image.width*this._skyline1.scaleX<=0){this._skyline1.x=1238}if(this._skyline1.x<=-i){this._skyline1.x=0}this._skyline2.x=this._skyline2.x-s*30;if(this._skyline2.x+this._skyline2.image.width*this._skyline2.scaleX<=0){this._skyline2.x=1238}if(this._skyline2.x<=0){this._skyline2.x=i}var n=e.delta/1e3;this._hill1.x=this._hill1.x-n*60;if(this._hill1.x+this._hill1.image.width*this._hill1.scaleX<=0){this._hill1.x=1464}if(this._hill1.x<=-i){this._hill1.x=0}this._hill2.x=this._hill2.x-n*60;if(this._hill2.x+this._hill2.image.width*this._hill2.scaleX<=0){this._hill2.x=1464}if(this._hill2.x<=0){this._hill2.x=i}Y.update();t.update();D++;var r=Math.floor(60-_*2);if(D%r===0){D=0;var o=this._oControlManager.getContent();var h=o[Math.floor(Math.abs(Math.random())*o.length)];m.getSoundManager().play("Controlshot");I.spawnGameObject({gameObjectType:A.CONTROL,shapeType:B.POLYGON,control:h,width:h._image.width,height:h._image.height,x:i,y:a-300,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true},this._playerBody,this._player)}}},dropTable:function(){if(this._oALVTable){if(this._oALVTable.GetUserData()){t.removeChild(this._oALVTable.GetUserData().skin);L.splice(L.indexOf(this._oALVTable.GetUserData()),1)}this._oALVTable.SetUserData(null);C.DestroyBody(this._oALVTable)}this._oALVTable=I.spawnGameObject({assetId:"ALVTable",shapeType:B.POLYGON,width:500,height:373,x:l.GetPosition().x*c-250,y:a-800,snapToPixel:true,mouseEnabled:false,density:15,isStaticBody:false,hasBox2dBody:true},this._playerBody,this._player);this._oALVTable.ApplyImpulse(new S(Math.random()*5,10),this._oALVTable.GetPosition())},init:function(){return new Promise(function(e,h){u=e;n=this._oCanvas.getDomRef();r=this._oDebugCanvas.getDomRef();o=r.getContext("2d");createjs.MotionGuidePlugin.install();t=new createjs.Stage(n);t.snapPixelsEnabled=true;i=this._oCanvas.$().width();a=this._oCanvas.$().height();Y.setup();var y=function(){g=setTimeout(function(){var e=Date.now()-b;var t=Date.now()-x;e=Math.floor(e/1e3);t=Math.floor(t/1e3);if(t<3&&e>0){m.score(Math.max(10,e*100*_/20),[l.GetPosition().x*c-25,l.GetPosition().y*c+25]);m.triggerEvent("Awesome")}y()},3e3)};x=Date.now()-3e3;b=Date.now()+3e3;y();var p=function(){f=setTimeout(function(){var e=(Date.now()-k)/1e3;if(e>3&&!d){m.triggerEvent("PointsCritical","Move!",[l.GetPosition().x*c-25,l.GetPosition().y*c+25]);d=true}if(e>6){setTimeout(function(){m.score(-1e3,[l.GetPosition().x*c-25,l.GetPosition().y*c+25]);m.triggerEvent("Ohno");k=Date.now()+5e3;d=false},1e3);this.dropTable();m.getSoundManager().play("devil")}p()}.bind(this),3e3)}.bind(this);k=Date.now()+1e4;p();var v=sap.ui.require.toUrl("flush/game/levels/Uncontrollable/assets");s=new createjs.LoadQueue(false);s.on("complete",this.onLoadingCompleted,this);s.crossOrigin="";s.loadFile({id:"robot",src:v+"/robo.png"});s.loadFile({id:"skyline",src:v+"/skyline.png"});s.loadFile({id:"playerSprite",src:v+"/spritesheet_CodiFaehrtUndSpringt.png"});s.loadFile({id:"phoenix",src:v+"/phoenix.png"});s.loadFile({id:"cloud",src:v+"/clouds.png"});s.loadFile({id:"hill",src:v+"/hill.png"});s.loadFile({id:"ALVTable",src:v+"/ALVTable.png"})}.bind(this))},onLoadingCompleted:function(){createjs.Ticker.addEventListener("tick",createjs.Tween);this._hill1=new createjs.Bitmap(s.getResult("hill"));this._hill1.width=1464;this._hill1.height=768;this._hill1.alpha=.1;this._hill1.x=0;this._hill1.y=a-this._hill1.height+80;t.addChild(this._hill1);this._hill2=new createjs.Bitmap(s.getResult("hill"));this._hill2.width=1464;this._hill2.height=768;this._hill2.alpha=.1;this._hill2.x=i+194;this._hill2.y=a-this._hill2.height+80;t.addChild(this._hill2);this._skyline1=new createjs.Bitmap(s.getResult("skyline"));this._skyline1.width=1238;this._skyline1.height=475;this._skyline1.alpha=.3;this._skyline1.x=0;this._skyline1.y=a-this._skyline1.height+7;t.addChild(this._skyline1);this._skyline2=new createjs.Bitmap(s.getResult("skyline"));this._skyline2.width=1238;this._skyline2.height=475;this._skyline2.alpha=.3;this._skyline2.x=i;this._skyline2.y=a-this._skyline2.height+7;t.addChild(this._skyline2);I.spawnGameObject({spriteSheet:new createjs.SpriteSheet({framerate:1,images:[s.getResult("playerSprite")],frames:{height:153,count:28,width:99,spacing:10},animations:{run:[0,0,"stay",1.5],jump:[20,26],fly:[27,27]}}),spriteSheetAnimation:"run",gameObjectType:A.PLAYER,shapeType:B.POLYGON,width:"99",height:"143",x:100,y:a-2e3,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true});this._robot=new createjs.Bitmap(s.getResult("robot"));this._robot.x=i-186;this._robot.y=a-143;t.addChild(this._robot);var e=new createjs.Bitmap(s.getResult("phoenix"));e.scaleX=-1;e.regY=250;e.regX=200;t.addChild(e);createjs.Tween.get(e).to({guide:{path:[-200,-200,0,200,400,200,600,200,800,-200]}},7e3);var n=new createjs.Bitmap(s.getResult("cloud"));n.y=-50;n.scaleX=1.240234375;n.alpha=.5;t.addChild(n);this._oControlManager.updateAllControlImages().then(function(){createjs.Ticker.setFPS(30);createjs.Ticker.addEventListener("tick",this.tick.bind(this));u();m.getSoundManager().play("Adlerschrei")}.bind(this))},exit:function(){return new Promise(function(e,i){if(t){t.removeAllChildren();createjs.Ticker.removeAllEventListeners();createjs.Tween.removeAllTweens();t=null}clearTimeout(v);clearTimeout(g);clearTimeout(f);document.removeEventListener("keydown",this.fnKeyDown);document.removeEventListener("keyup",this.fnKeyUp);e()}.bind(this))},setDifficulty:function(e){_=Math.min(e,50)}})});