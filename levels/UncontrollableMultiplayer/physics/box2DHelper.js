sap.ui.define(["sap/ui/base/EventProvider","./../helper/time"],function(e,t){"use strict";var a={PLAYER:1,PLAYERBOTTOM:2,RENDERMANAGER:3,CONTROL:4,LASERPARTICLE:5,LEFTWALL:6,RIGHTWALL:7,FLOOR:8,ROOF:9,CONTROLPACKAGE:10};var i={POLYGON:1,CIRCLE:2};var r,n,o;var s=1,y=20,p=1/y;var b=30;var d=Date.now();var u=0;var c=[];var h=[];var l=[];var v={};var O=[];var f;var m=function(){};var D=function(){};var T=function(){};var A={};var L;var B=[];var R=Box2D.Common.Math.b2Vec2;var C=Box2D.Dynamics.b2BodyDef;var g=Box2D.Dynamics.b2Body;var G=Box2D.Dynamics.b2FixtureDef;var x=Box2D.Dynamics.b2World;var w=Box2D.Collision.Shapes.b2PolygonShape;var E=Box2D.Collision.Shapes.b2CircleShape;var S=Box2D.Dynamics.b2DebugDraw;var k=Box2D.Dynamics.b2ContactListener;var P=function(e,i,y,p,d,u,h){r=e.width;n=e.height;o=i.getContext("2d");m=y;D=u;T=p;h=h;f=d;L=new x(new R(0,3),true);var l=new S;l.SetSprite(o);l.SetDrawScale(b);l.SetFillAlpha(.7);l.SetLineThickness(1);l.SetFlags(S.e_shapeBit|S.e_jointBit);L.SetDebugDraw(l);var v=new G;v.density=1;v.restitution=.5;v.shape=new w;v.shape.SetAsBox(r/b,s/b);var O=new C;O.type=g.b2_staticBody;O.position.x=0;O.position.y=-1e3/b;O.userData={gameObjectType:a.ROOF};var A=L.CreateBody(O);A.CreateFixture(v);var B=new G;B.density=1;B.restitution=.5;B.shape=new w;B.shape.SetAsBox(r/b,s/b);var E=new C;E.type=g.b2_staticBody;E.position.x=0;E.position.y=n/b;E.userData={gameObjectType:a.FLOOR};var P=L.CreateBody(E);P.CreateFixture(B);var j=new G;j.shape=new w;j.density=1;j.shape.SetAsBox(s/b,n+1e3/b);var N=new C;N.type=g.b2_staticBody;N.position.x=0;N.position.y=n/b;N.userData={gameObjectType:a.LEFTWALL};var U=L.CreateBody(N);U.CreateFixture(j);var F=new G;F.shape=new w;F.density=1;F.shape.SetAsBox(s/b,n+1e3/b);var Y=new C;Y.type=g.b2_staticBody;Y.position.x=r/b;Y.position.y=n/b;Y.userData={gameObjectType:a.RIGHTWALL};var I=L.CreateBody(Y);I.CreateFixture(F);var _=new k;_.BeginContact=function(e){var i=e.GetFixtureA();var r=e.GetFixtureB();var n={a:{fixture:i,body:i.GetBody(),skin:i.GetBody()&&i.GetBody().skin},b:{fixture:r,body:r.GetBody(),skin:r.GetBody()&&r.GetBody().skin}};n.a.type=n.a.fixture&&n.a.fixture.GetUserData()&&n.a.fixture.GetUserData().gameObjectType||n.a.body&&n.a.body.GetUserData()&&n.a.body.GetUserData().gameObjectType;n.b.type=n.b.fixture&&n.b.fixture.GetUserData()&&n.b.fixture.GetUserData().gameObjectType||n.b.body&&n.b.body.GetUserData()&&n.b.body.GetUserData().gameObjectType;if(n.a.body.GetUserData()&&n.a.body.GetUserData().gameObjectType&&n.a.body.GetUserData().gameObjectType===a.PLAYER&&n.a.type!==a.PLAYERBOTTOM&&n.b.type===a.CONTROL||n.b.body.GetUserData()&&n.b.body.GetUserData().gameObjectType&&n.b.body.GetUserData().gameObjectType===a.PLAYER&&n.b.type!==a.PLAYERBOTTOM&&n.a.type===a.CONTROL){var o=n.a.type===a.CONTROL?n.a.skin:n.b.skin;m(n.a.skin&&n.a.skin.playerNumber||n.b.skin&&n.b.skin.playerNumber,o);return}if(n.a.type===a.LASERPARTICLE||n.b.type===a.LASERPARTICLE){var s=n.a.type===a.LASERPARTICLE;var y=n.b.type===a.LASERPARTICLE;if(s&&y){if(n.a.body&&n.a.body.m_userData!==undefined){c.push(n.a.body)}if(n.b.body&&n.b.body.m_userData!==undefined){c.push(n.b.body)}}else{var p=s?n.a:n.b;var b=s?n.b:n.a;if(b.type===a.PLAYER&&b.skin&&b.skin.playerNumber&&p.skin&&p.skin.createdBy&&p.skin.createdBy!==b.skin.playerNumber){if(p.body.m_userData!==undefined){c.push(p.body)}}if(b.type===a.CONTROL&&b.body.m_userData!==undefined){h.play("laserHitsControl");c.push(b.body)}}}if((n.a.type===a.PLAYER||n.a.type===a.PLAYERBOTTOM)&&n.b.type===a.CONTROLPACKAGE&&!n.b.body.GetUserData().collected){n.b.body.GetUserData().collected=true;T(n.a.skin.playerNumber,n.b.skin);t.setTimeout(function(){c.push(n.b.body)},1e3)}else if((n.b.type===a.PLAYER||n.a.type===a.PLAYERBOTTOM)&&n.a.type===a.CONTROLPACKAGE&&!n.a.body.GetUserData().collected){n.a.body.GetUserData().collected=true;T(n.b.skin.playerNumber,n.a.skin);t.setTimeout(function(){if(n.a.body&&n.a.body.GetUserData()!==null){c.push(n.a.body)}},1e3)}};L.SetContactListener(_)};var j=function(e,t){this.body=e;this.skin=t;this.update=function(){this.skin.rotation=this.body.GetAngle()*(180/Math.PI);this.skin.x=this.body.GetWorldCenter().x*b;this.skin.y=this.body.GetWorldCenter().y*b};B.push(this)};var N=function(e,t){var r=new G;r.density=e.density;r.restitution=.1;var n=new C;if(e.shapeType==i.POLYGON){r.shape=new w;if(e.gameObjectType==a.PLAYER){r.shape.SetAsBox(e.width/b/2,(e.height-30)/b/2)}else{r.shape.SetAsBox(e.width/b/2,e.height/b/2)}n.position.x=(e.x+e.width/2)/b;n.position.y=(e.y+e.height/2)/b}if(e.shapeType==i.CIRCLE){r.shape=new E(e.width/2/b);n.position.x=e.x/b;n.position.y=e.y/b}if(e.isStaticBody===true){n.type=g.b2_staticBody}else{n.type=g.b2_dynamicBody}var o=L.CreateBody(n);o.skin=e;if(e.gameObjectType==a.LASERPARTICLE){o.SetFixedRotation(true);o.ApplyForce(new R(0,-3),new R(0,1));o.ApplyImpulse(new R(e.direction*75,-2),o.GetPosition());O.push({body:o,skin:e})}if(e.gameObjectType==a.PLAYER){v[e.playerNumber-1]={body:o,skin:e}}if(e.gameObjectType==a.PLAYER){var s=new G;s.density=e.density;s.restitution=.1;s.shape=new w;s.shape.SetAsOrientedBox(e.width/b/2,13/b,new R(0,e.height/2/b));s.userData={gameObjectType:a.PLAYERBOTTOM};o.CreateFixture(s)}var y=o.CreateFixture(r);y.skin=e;if(e.gameObjectType==a.CONTROL){var p=Math.min(e.loadedTime/1e3,3);o.ApplyImpulse(new R(p*25*e.direction*t*o.m_mass/10,0),o.GetPosition())}var d=new j(o,e);var u={actor:d,gameObjectType:e.gameObjectType};if(e.gameObjectType===a.CONTROLPACKAGE){u.collected=false}if(e.gameObjectType===a.CONTROL||e.gameObjectType===a.CONTROLPACKAGE){o.objSkin=e;h.push(o)}else{l.push(o)}o.SetUserData(u);return o};var U=function(){var e=Date.now();var t=e-d;u+=t;d=e;while(u>=y){for(var a=0,i=c.length;a<i;a++){D(c[a].GetUserData()&&c[a].GetUserData().actor,B);c[a].SetUserData(null);L.DestroyBody(c[a])}c=[];for(var a=0,i=B.length;a<i;a++){B[a].update()}L.Step(p,10,10);u-=y;L.ClearForces();L.m_debugDraw.m_sprite.graphics.clear();L.DrawDebugData();if(h.length>30){c.push(h[0]);h.splice(0,1)}}};var F=function(){for(var e=0;e<h.length;e++){c.push(h[e])}};var Y=function(e){function a(e,t){e=Math.ceil(e);t=Math.floor(t);return Math.floor(Math.random()*(t-e))+e}function i(i,r,n){var o=1/n;function s(e){var a=t.setInterval(function(){i[e].objSkin.alpha-=o;if(i[e].objSkin.alpha<=0){clearInterval(a);c.push(i[e])}},r*1e3/n)}for(var y=0;y<i.length;y++){i[y].ApplyImpulse(new R(a(50,200)*f,a(3e3,5e3)*f),i[y].GetPosition());e.play("big_bomb");s(y)}}i(h,.5,50)};var I=function(e){if(e){p=0}else{p=1/y}d=Date.now()};var _=function(){};return{init:P,applyBombEffect:Y,update:U,createGameObjectBodyAndActor:N,pauseResume:I,playerBody:function(e){return v[String(e)].body},playerSkin:function(e){if(e!==undefined){return v[String(e)].skin}else{return Object.keys(v).map(function(e){return v[e].skin})}},removeAllControls:F,types:{gameObjects:a,shapes:i},destroy:_}});